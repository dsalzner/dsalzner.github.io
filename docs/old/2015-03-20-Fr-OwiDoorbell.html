<html>
<head>
	<title>Dennis Salzner - 2015-03-20-Fr-OwiDoorbell</title>
	
	<style type="text/css">
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }
body .hll { background-color: #ffffcc }
body  { background: #f8f8f8; }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #888888 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
 
  <!-- stats -->
<script type="text/javascript">
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//dennissalzner.de/stats/matomo/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
  <!-- stats -->
</head>

<body>

<h1>Dennis Salzner - 2015-03-20-Fr-OwiDoorbell</h1>
<link rel="image_src" href="grafiken/2015-03-20-Fr-OwiDoorbell/004t.jpg" />

<p align="right" style="font-size:80%">
	<a href="../"><< Back Home</a> 
</p>
			
<table style="width:100%">
	<tr>
		<td style="vertical-align: top;">
			<a href="#null" onclick="newWindow('grafiken/2015-03-20-Fr-OwiDoorbell/001.jpg','','640','480','')">
				<img src="grafiken/2015-03-20-Fr-OwiDoorbell/001t.jpg" width="160" height="148">
			</a>
			<p style="font-size:75%; margin-top: 0;">
				Fig.1: Unmodified doorbell
			</p>
			<a href="#null" onclick="newWindow('grafiken/2015-03-20-Fr-OwiDoorbell/002.jpg','','640','480','')">
				<img src="grafiken/2015-03-20-Fr-OwiDoorbell/002t.jpg" width="160" height="133">
			</a>
			<p style="font-size:75%; margin-top: 0;">
				Fig.2: Stripe board circuit without wires
			</p>
			<a href="#null" onclick="newWindow('grafiken/2015-03-20-Fr-OwiDoorbell/003.jpg','','640','480','')">
				<img src="grafiken/2015-03-20-Fr-OwiDoorbell/003t.jpg" width="160" height="147">
			</a>
			<p style="font-size:75%; margin-top: 0;">
				Fig.3: Stripe board circuit with wiring
			</p>
			<a href="#null" onclick="newWindow('grafiken/2015-03-20-Fr-OwiDoorbell/004.jpg','','640','480','')">
				<img src="grafiken/2015-03-20-Fr-OwiDoorbell/004t.jpg" width="160" height="138">
			</a>
			<p style="font-size:75%; margin-top: 0;">
				Fig.4: In a junction box - relay version.
			</p>
			<a href="#null" onclick="newWindow('grafiken/2015-03-20-Fr-OwiDoorbell/005.png','','640','480','')">
				<img src="grafiken/2015-03-20-Fr-OwiDoorbell/005t.png" width="160" height="119">
			</a>
			<p style="font-size:75%; margin-top: 0; margin-bottom: 0;">
				Fig.5: Schematic
			</p>
			<a href="#null" onclick="newWindow('grafiken/2015-03-20-Fr-OwiDoorbell/006.jpg','','640','480','')">
				<img src="grafiken/2015-03-20-Fr-OwiDoorbell/006t.jpg" width="160" height="162">
			</a>
			<p style="font-size:75%; margin-top: 0; margin-bottom: 0;">
				Fig.6: Reading the counter with a cell phone
			</p>
			<a href="#null" onclick="newWindow('grafiken/2015-03-20-Fr-OwiDoorbell/007.png','','640','480','')">
				<img src="grafiken/2015-03-20-Fr-OwiDoorbell/007t.png" width="160" height="90">
			</a>
			<p style="font-size:75%; margin-top: 0; margin-bottom: 0;">
				Fig.7 Redesign
			</p>
			<a href="#null" onclick="newWindow('grafiken/2015-03-20-Fr-OwiDoorbell/008.jpg','','640','480','')">
				<img src="grafiken/2015-03-20-Fr-OwiDoorbell/008t.jpg" width="160" height="94">
			</a>
			<p style="font-size:75%; margin-top: 0; margin-bottom: 0;">
				Fig.8 Final result
			</p>

		</td>
		<td style="vertical-align: top;">
			<!-- Titel -->
			<h2>
				1-Wire Doorbell and Internet
			</h2>
			<!-- Was -->
			<p align="right" style="font-size:60%">What?</p>
			<p style="font-size:80%">
				My doorbell doesn't work properly. So I set out to fix it. But then I realized I couldn't do so easily. The reason is a faulty switch outside of my appartment.  I can't repair it, because there is mains current running through another switch next to it. I can't shut that off, because the fuse is located somewhere in the building and I don't know where.
				
				But I had to do something. After all I had set out to "fix" something. So I decided to connect my doorbell to the internet.
			</p>
			<!-- Wann -->
			<p align="right" style="font-size:60%">When?</p>
			<p style="font-size:80%">
				I was sitting here the other day trying to study. Got bored. Thought about ordering pizza. But damn - the doorbell doesn't work. Opened it up. Realized I couldn't do much as of now. But then...
			</p>
			<!-- Warum -->
			<p align="right" style="font-size:60%">Why?</p>
			<p style="font-size:80%">
				People usually notice the disfunctional bell. They can hear that it's not rining. Then they decide to knock - or they wait even longer. But nobody likes to wait... they do knock. But then they ask me why I haven't fixed it. It's becoming a running gag with my friends.
			</p>
			<!-- Hintergrund -->
			<p align="right" style="font-size:60%">Background?</p>
			<p style="font-size:80%">
				My doorbell is a very simple device: There is a 9V battery and a solenoid which hits a metal plate on rubber hinges that creates the sound (Fig.1). The switch outside functions as - you guessed it - a switch. It closes the circuit thereby connecting the battery with the solenoid, which triggers it.
			</p>
			<!-- Wie -->
			<p align="right" style="font-size:60%">How?</p>
			<p style="font-size:80%">
				So how can I connect the thing to the internet? I have a One-Wire Bus running through parts of my appartment and, fortunatly, near the entrance door. A One-Wire Bus consists of a master device. This master device controls slave devices, which are daisy-chained along one long cable. This cable is connected to the master device. Slave devices can be anything from analog/digital inputs or outputs to temperature sensors. The master can read the values of the slaves and feed them into a computer. Each slave has a unique id by which it can be addressed.
			<br><br>
				The big advantage of the One-Wire Bus over say the CAN or RS485 are readily available components. There is no need for microcontrollers and all the work that goes into programming them. Most slave devices are also parasitic - which means they get by using power only from the bus data lines. This makes external power supplies or batteries for the slaves unnecessary.
			<br><br>
				A disadvantage is that 1-Wire only allows one master on each bus. The trouble with this is that sensors cannot speak on the bus without being asked to do so by the master. What this means is that sensors have to be actively polled in order to catch changes. Push buttons for example would need to be held down until the Master polls and registers the new state. Short changes can easily be missed.
			<br><br>
				But what I can do is use counter IC's. A counter keeps track of how often a button was pressed and it can react to fast changes as well. The master will be able to register the changes even if it missed the event by looking at the state of the counter later on.
				The company that produces 1-Wire devices used to sell the DS2423 - a 4kBit Counter IC which acts as a slave device. But they've discontinued it.
			<br><br>
				What I do now is connect a DS2408 8 Bit input/output slave device to a 74HC590 Counter-IC. Then I put a HEF40106B Schmitt-Trigger in front in order to debang the switch. Otherwise one button press could be registered as multiple presses.
				This solution proved to work fairly well. I've used this to monitor energy meters and my gas meter (well the later didn't work that well, but that's another story). Now I'm connecting it to my doorbell.
			<br><br>
				What does all this mean? The 1-Wire Master can poll the slave for the state of its 8-Bit I/O Pins. The answer is the state of the counter IC connected to it. The master is hooked to a linux server, which can use this information and do whatever I tell it to do. So if the counter state changes - I tell it to E-Mail me. And the counter IC increments each time someone rings the bell. So there you have it: Doorbell connected ot the internet.	
			</p>
			<!-- Fortschritt -->
			<p align="right" style="font-size:60%">Progress?</p>
			<p style="font-size:80%">
				I've decided to solder directly onto a stripe board. Connecting the SMD type 1-Wire Chip was a pain, but it was still a lot quicker than designing and etching a PCB. What I do nowadays is use many socket strips (Fig.2). That way I can jumper around wires anywhere I need them (Fig.3). It doesn't look nice, but it works. And wires don't come loose - usually.
			<br><br>
				And this was a very wise choice as I realized I had to make some changes later on. 
			
				My first design used an ULN2003A Darlington Transistor-Array. The idea was to have the switch trigger the counter-IC and the input of the ULN2003A. The output of the ULN2003A would run the 9 Volt for the bell.
				But this proved stupid: If the 5V line of the 1-Wire Bus would have been cut, the ULN2003A would shut off and the doorbell wouldn't work anymore. I also had a practical issue with this: It would mean running 2 wires for the battery power, 2 additional wires for the bell and 2 more wires for the switch - all going to my contraption. 
			<br><br>
				It turned out to be far more fail-safe and convenient to use a simple relay. This also isolates the circuits from each other. The relay is now hooked up directly to the doorbell circuitry. And the other side, the side that closes as soon as current is applied, is connected to the counter IC and to 5V logic power. The result is a much simpler circuit (Fig.4)
				
				The only remaining issue is that the solenoid causes fluctuations and these fluctuations cause the relay to switch back and forth. But as long as it doesn't do this exactly 255 times (this would overflow the counter and bring it back to the value it had before) - it's all good.
			<br><br>
				The final schematic is a mess, but it works for me (Fig.5).
			<br><br>
				And debugging and testing is fairly easy: I've connected my cell phone to my server via SSH (Fig.6). And then I ask the Linux library for 1-Wire (owfs) what the state of the counter is. Using "watch -n1 ..." in order to automatically refresh. That way I can ring my own bell, standing outside, while driving my neighbours insane and see if my server notices any of this, on my phone. And the whole thing doesn't look that bad - at least by my standards (Fig.8).
			<br><br>
				Oh and there's a 10k pull-up on the counter line...
			<br><br>
				Update 2015-03-21-Sa - Redesign 3:
			<br><br>
				I didn't like the oscillating relay. My first plan was to add a lowpass filter. Something to reduce the fluctuations to one clean peak. The circuitry in the bell is simplistic (Fig. 7a). Measuring the signals between battery and switch with an oszilloscope showed the oscillation (Fig. 7b). The fluctuations vary in voltage from -46V to 73V (Fig. 7c). I hadn't expected it to be that bad.
			<br><br>
				So I added a diode (1N4004) to remove current running back from the coil of the bell to the circuit. The result looked a lot better (Fig. 7d). All we see now is the switch toggling and the negative current. The rest is filtered out.
			I thought I could run the relay off of this. That worked, but only when the bell wasn't connected. I assumed this was due to the small resistance in the coil of the bell. The same circuit would drive either the bell or the relay depending on whether the wire to the bell was connected.
			<br><br>
				Then I tried to bring the resistance of the coil up to the level of the relay, but then the coil would hardly function (Fig. 7e). I decided to bring in transistors to drive the bell. A PNP, because the bell is wired to the negative lead of the battery  and I needed to switch the positive lead. After that I opened up the rest of the bell (Fig. 7f), rewired it and used an NPN transistor. I needed a very low resistor, 75 Ohms, connected to the transistors base for this to work.  But the same problem remained as before. I couldn't drive both the relay and the bell.
			<br><br>
				I still had the ULN2003A darlington transistor array, so I thought it would be a better choice and swapped the NPN transistor for it. But half way there I had a better idea: What about driving the bell with the relay instead of the counter. This is so stupidly obvious, but I was thinking in so many different ways I just didn't come up with that at first.
				But then the relay was oscillating again. Then I finally figured out that the relay I was using was rated for 12V and the 7 to 8V coming from the battery were far too weak. So I hooked up a 5V relay and that worked.
			<br><br>
				The end result is a switch that connects to the counter through a schmitt-trigger. The switch also activates a relay. This relay connects the solenoid in the bell to the battery (Fig. 7g). 
				I didn't bother adding a transistor to drive the relay. The bell's original circuit near shorts out the battery every time someone hits the switch anyway. And the counter can handle the 9V - after all I was hitting it with 73V peak before.
			<br><br>
				The device is now fully working (Fig.8).
			<br><br>
				What can I do with this? I can receive e-mails notifying me when someone was at the door. That way I know if I've missed the parcel delivery service. And I can have it automatically mute or pause the music - my music playback software also runs on the server.
			<br><br>
				Update 2015-03-23-Mo - E-Mail Notify:
			<br><br>
				E-Mail notification was easy to set up (on my Linux server). All I needed was msmtp. I configured it to use my gmail account to send emails.
			</p>
			
<div class="highlight"><pre>yum -y install msmtp</pre></div>

			<p style="font-size:80%">
				It had to be configured:
			</p>
			
<div class="highlight"><pre>vim ~/.msmtprc</pre></div>

<div class="highlight"><pre>
account default
host smtp.gmail.com
port 587
from <span class="o">[</span>email address<span class="o">]</span>
tls on
tls_starttls on
tls_trust_file /etc/ssl/certs/ca-bundle.crt
auth on
user <span class="o">[</span>email address<span class="o">]</span>
password <span class="o">[</span>password<span class="o">]</span>
logfile ~/.msmtp
</pre></div>

			<p style="font-size:80%">
				And then I was receiving E-Mails by issuing:
			</p>
			
<div class="highlight"><pre><span class="nb">echo</span> -e <span class="s2">&quot;Subject: Hi\n\nTest&quot;</span> | msmtp [email address]</pre></div>

			<p style="font-size:80%">
				I've written a short script in order to do this automatically when someone rings the bell:
			</p>
			
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="nv">ZNEU</span><span class="o">=</span><span class="sb">`</span>/usr/bin/owread /bus.0/<span class="o">[</span>1-Wire IC Address<span class="o">]</span>/sensed.BYTE 2&gt; /dev/null<span class="sb">`</span>
<span class="nv">ZALT</span><span class="o">=</span><span class="sb">`</span>cat /root/onewire/zaehler_klingel_wohnungstuer.txt<span class="sb">`</span>
<span class="nb">echo</span> <span class="nv">$ZNEU</span> &gt; /root/onewire/zaehler_klingel_wohnungstuer.txt

<span class="k">if</span> <span class="o">[</span> <span class="nv">$ZALT</span> -ne <span class="nv">$ZNEU</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">  </span><span class="nb">echo</span> -e <span class="s2">&quot;Subject: e350 Wohnungstuer\n\nEs hat geklinkelt&quot;</span> | /usr/bin/msmtp  <span class="o">[</span>E-Mail<span class="o">]</span>
<span class="k">fi</span>
</pre></div>
</td></tr></table>

			<p style="font-size:80%">
			All this does is check the counter. Overwrite the last seen value with the new one. Compare it to the last seen value. Send an E-Mail if they differ. One should make sure it is executable:
			</p>
			
<div class="highlight"><pre>
chmod +x /root/onewire/zaehler_klingel_wohnungstuer.sh
</pre></div>

			<p style="font-size:80%">
			And add it to crontab to make it run periodically. I set it up to check the bell every minute:
			</p>
			
<div class="highlight"><pre>
crontab -e
</pre></div>

<div class="highlight"><pre>
*/1 * * * * /root/onewire/zaehler_klingel_wohnungstuer.sh
</pre></div>

			<p style="font-size:80%">
			Now I receive E-Mails within a minute when someone rings the bell.
			
			</p>
		</td>

	</tr>
</table>

<!-- -------------------------------------------------------------------------------------- -->
<script type="text/javascript" language="JavaScript">
// Centered Pop-Up Window (v1.0)
// (C) 2002-2005 www.smileycat.com
// Free for all users, but leave in this header</code><br>

var win = null;
function newWindow(mypage,myname,w,h,features) {
  var winl = (screen.width-w)/2;
  var wint = (screen.height-h)/2;
  if (winl = 0) winl = 0;
  if (wint = 0) wint = 0;
  var settings = 'height=' + h + ',';
  settings += 'width=' + w + ',';
  settings += 'top=' + wint + ',';
  settings += 'left=' + winl + ',';
  settings += features;
  win = window.open(mypage,myname,settings);
  win.window.focus();
}
</script>

</body>
</html>
