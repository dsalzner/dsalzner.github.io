<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Dennis Salzner</title>

  <!-- search engine -->
  <meta name="description" content="Dennis Salzner"/>
  <link rel="canonical" href="/computers/2018/12/17/SelfHostedCalendarDAViCalAgenDAV.html">
  <meta property="og:locale" content="en_EN" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Self-Hosted Calendar with DAViCal and AgenDAV on Ubuntu 18.04.1 LTS - Dennis Salzner" />
  <meta property="og:description" content="Installing a self-hosted calendar involves jumping through some hoops as documentation is sparse. In the following I will try to describe the steps required ..." />
  <meta property="og:url" content="/computers/2018/12/17/SelfHostedCalendarDAViCalAgenDAV.html" />
  <meta property="og:site_name" content="Dennis Salzner" />
  <meta property="article:section" content="computers" />
  <meta property="article:published_time" content="2018-12-17 00:00:00 +0100" />
  <meta property="article:modified_time" content="2018-12-17 00:00:00 +0100" />
  <meta property="og:updated_time" content="2018-12-17 00:00:00 +0100" />
  <meta property="og:image" content="" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:description" content="Installing a self-hosted calendar involves jumping through some hoops as documentation is sparse...." />
  <meta name="twitter:title" content="Self-Hosted Calendar with DAViCal and AgenDAV on Ubuntu 18.04.1 LTS - Dennis Salzner" />
  <meta name="twitter:image" content="" />

   
  <!-- syntax highlighting in code snippets -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/style.css">

  
  <!-- jquery (for vimeo video embedding)-->
  <script src="/js/jquery.min.js"></script>
  
  <!-- photos -->
  <script src="/js/lightbox.js"></script>
  <link href="/css/lightbox.css" rel="stylesheet">
  
  <!-- diagramms -->
  <script src="/js/mermaid.min.js"></script>

</head>

  <body>
    <div style="margin: 32px;">
    
<h1>Dennis Salzner - 2018-12-17-SelfHostedCalendarDAViCalAgenDAV</h1>
<p align="right" style="font-size:80%"><a href="/"><< Back Home</a></p>
<div class="page-title">Self-Hosted Calendar with DAViCal and AgenDAV on Ubuntu 18.04.1 LTS</div>
<div class="page-subtitle">Setting up an online calendar on your home server</div>
<div class="page-seperator"></div>

<div class="post-content" itemprop="articleBody">
    <p style="font-size: 60%;" align="right">What</p>
<p style="font-size: 60%;" align="right">When</p>
<p style="font-size: 60%;" align="right">Background</p>
<p style="font-size: 60%;" align="right">How</p>

<h2 id="postgressql">PostgresSQL</h2>

<h3 id="install">Install</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt install postgresql postgresql-contrib
</code></pre></div></div>

<h3 id="create-user-for-davical">Create user for DAViCal</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo -u postgres createuser davical_app
sudo -u postgres createuser davical_dba
</code></pre></div></div>

<h3 id="set-access-rights">Set Access Rights</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /etc/postgresql/10/main/pg_hba.conf
</code></pre></div></div>

<p>Add (above everything else):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local   davical     davical_dba                     trust
local   davical     davical_app                     trust
</code></pre></div></div>

<h3 id="restart-postgres">Restart Postgres</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo /etc/init.d/postgresql restart
</code></pre></div></div>

<h3 id="check-postgres-is-running">Check Postgres is running</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netstat -an | grep 5432
</code></pre></div></div>

<h2 id="davical">DaviCal</h2>

<h3 id="install-1">Install</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install davical davical-doc
</code></pre></div></div>

<p>and some dependencies for the create-database script to work (may not need all of them):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install libpq-dev
sudo apt-get install python-yaml
sudo apt-get install libyaml-dev
sudo apt install libyaml-perl
sudo cpan YAML
</code></pre></div></div>

<h3 id="configure">Configure</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /etc/davical/config.php
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$c-&gt;pg_connect[] = "dbname=davical user=davical_app";
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo chmod 644 /etc/davical/config.php
</code></pre></div></div>

<h3 id="restart-postgres-1">Restart Postgres</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo /etc/init.d/postgresql restart
</code></pre></div></div>

<h3 id="create-database-schema">Create Database Schema</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo -u postgres -s /usr/share/davical/dba/create-database.sh
</code></pre></div></div>

<p>if it fails, run:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo -u postgres -s psql  -c "drop database davical;"
</code></pre></div></div>
<p>fix issue and re-run create-database.</p>

<p>Take note of the generated admin password</p>

<h2 id="apache">Apache</h2>

<h3 id="configure-apache-site-for-davical">Configure Apache site for DAViCal</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /etc/apache2/conf-available/davical.conf
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Alias /davical /usr/share/davical/htdocs
&lt;Directory /usr/share/davical/htdocs&gt;
  Require all granted
  Options Indexes
  DirectoryIndex index.php
  php_flag magic_quotes_gpc Off
  php_flag register_globals Off
&lt;/Directory&gt;
</code></pre></div></div>

<h3 id="restart-apache">Restart Apache</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo systemctl restart apache2
</code></pre></div></div>

<h3 id="create-davical-user-principal">Create DAViCal User (“Principal”)</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://188.195.24.79/davical/
</code></pre></div></div>

<p>Login with “admin” and the generated password.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"user functions" -&gt; "create principal"
</code></pre></div></div>

<p>fill-out all fields (username, password, display name, e-mail, language)
otherwise “too few arguments” error will appear</p>

<p>Grant Access:</p>

<p>Access Rights princiapls, select principal name from drop-down list, click on “Read/Write” and “Create”</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Home -&gt; Log-Out
</code></pre></div></div>

<h3 id="test">Test</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://&lt;Server-IP&gt;/davical/caldav.php/&lt;Principal Name&gt;/calendar/
</code></pre></div></div>

<p>should respond with an *.ics file when logging in as user with the configured password</p>

<h2 id="agendav">AgenDAV</h2>

<h3 id="install-2">Install</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://github.com/agendav/agendav/releases/download/2.2.0/agendav-2.2.0.tar.gz
tar -xvf agendav-2.2.0.tar.gz
sudo mv agendav-2.2.0 /var/www
</code></pre></div></div>

<h3 id="configure-php-for-agendav">Configure PHP for AgenDAV</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /etc/php/7.2/apache2/php.ini
</code></pre></div></div>

<p>Set the Timezone, i.e.:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>date.timezone = "Europe/Berlin"
</code></pre></div></div>

<p>(may need to set “magic_quotes_runtime”)</p>

<h3 id="configure-postgres-for-agendav">Configure Postgres for AgenDAV</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /etc/postgresql/10/main/pg_hba.conf
</code></pre></div></div>

<p>Add (above everything else):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local   agendav     agendav                           md5
</code></pre></div></div>

<h3 id="configure-1">Configure</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp /var/www/html/agendav-2.2.0/web/config/default.settings.php /var/www/html/agendav-2.2.0/web/config/settings.php
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /var/www/html/agendav-2.2.0/web/config/settings.php
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$app['db.options'] = [
        'dbname' =&gt; 'agendav',
        'user' =&gt; 'agendav',
        'password' =&gt; 'agendavpw',
        'host' =&gt; 'localhost',
        'driver' =&gt; 'pdo_pgsql'
];
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$app['caldav.certificate.verify'] = false; //true;
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$app['caldav.baseurl'] = 'https://&lt;Server-IP&gt;/davical/caldav.php/&lt;PrincipalName&gt;/calendar/';
</code></pre></div></div>

<h3 id="patch-postgressql-connector">Patch PostgresSQL Connector</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /var/www/agendav-2.2.0/web/vendor/doctrine/dbal/lib/Doctrine/DBAL/Schema/PostgreSqlSchemaManager.php
</code></pre></div></div>

<p>Change</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$data = $this-&gt;_conn-&gt;fetchAll('SELECT min_value, increment_by FROM ' . $this-&gt;_platform-&gt;quoteIdentifier($sequenceName));
</code></pre></div></div>
<p>to:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $version = floatval($this-&gt;_conn-&gt;getWrappedConnection()-&gt;getServerVersion());

    if ($version &gt;= 10) {
       $data = $this-&gt;_conn-&gt;fetchAll('SELECT min_value, increment_by FROM pg_sequences WHERE schemaname = \'public\' AND sequencename = '.$this-&gt;_conn-&gt;quote($sequenceName));
    }
    else
    {
        $data = $this-&gt;_conn-&gt;fetchAll('SELECT min_value, increment_by FROM ' . $this-&gt;_platform-&gt;quoteIdentifier($sequenceName));
    }
</code></pre></div></div>

<h3 id="create-database-schema-1">Create Database Schema</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /var/www/agendav-2.2.0/
php agendavcli migrations:migrate
</code></pre></div></div>

<h3 id="configure-apache-for-agendav">Configure Apache for AgenDAV</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /etc/apache2/sites-available/default-ssl.conf
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Alias /agendav /var/www/agendav-2.2.0/web/public
&lt;Location /agendav&gt;
           Require all granted
           RewriteEngine On
           RewriteCond %{REQUEST_FILENAME} !-f
           RewriteRule ^ index.php [QSA,L]
&lt;/Location&gt;
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a2enmod rewrite
sudo systemctl restart apache2
</code></pre></div></div>

<h3 id="check-logs">check logs</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat /var/www/agendav-2.2.0/web/var/log/*.log
cat /var/log/apache2/error.log
</code></pre></div></div>

<h3 id="test-1">Test</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://&lt;Server-IP&gt;/agendav
</code></pre></div></div>

<p>Login with username and password that was configured in DAViCal</p>

<h2 id="references">References</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://wiki.ubuntuusers.de/DAViCal/#Installation
https://www.shayanderson.com/linux/install-and-setup-davical-on-ubuntu-server-12-04.htm
http://docs.agendav.org/en/2.2.0/admin/installation/
https://github.com/agendav/agendav/issues/229
https://framework.zend.com/manual/2.1/en/modules/zend.db.adapter.html
https://www.linuxfrickeln.de/2016/04/07/howto-installation-agendav-caldav-webclient-unter-debian-8-jessie/
https://github.com/agendav/agendav/issues/229
https://github.com/doctrine/dbal/issues/2868
https://agendav.readthedocs.io/en/2.2.0/admin/installation/
https://partofthething.com/thoughts/host-your-own-contacts-and-calendars-and-share-them-across-devices/
</code></pre></div></div>

<h2 id="missing-pieces">Missing pieces</h2>

<ul>
  <li>Postgres User for AgenDav?</li>
  <li>Login with user other than admin?</li>
  <li>which dependencies are required for davical create schema script?</li>
  <li>configure agendav as a site as well?</li>
</ul>

<p style="font-size: 60%;" align="right">Progress</p>


</div>

</div>



    <div class="footer">
  D.Salzner : www.dennissalzner.de : 2021
</div>

  </body>
</html>
