<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>CustomOS - Pt.7 - Interfacing with Rust - Dennis Salzner</title>
  
  
  <!-- search engine -->
  <meta name="description" content="To further enhance the CustomOS we need a shell. We can write it in the Rust programming language. Here are the first steps to get started."/>
  <link rel="canonical" href="https://www.dennissalzner.de/programming/2024/01/28/So-CustomOsPt7-Shell-Rust.html">
  <meta property="og:locale" content="en_EN" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="CustomOS - Pt.7 - Interfacing with Rust - Dennis Salzner" />
  <meta property="og:description" content="To further enhance the CustomOS we need a shell. We can write it in the Rust programming language. Here are the first steps to get started." />
  <meta property="og:url" content="https://www.dennissalzner.de/programming/2024/01/28/So-CustomOsPt7-Shell-Rust.html" />
  <meta property="og:site_name" content="Dennis Salzner" />
  <meta property="article:section" content="Programming" />
  <meta property="article:published_time" content="2024-01-28 00:00:00 +0100" />
  <meta property="article:modified_time" content="2024-01-28 00:00:00 +0100" />
  <meta property="og:updated_time" content="2024-01-28 00:00:00 +0100" />
  <meta property="og:image" content="" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:description" content="To further enhance the CustomOS we need a shell. We can write it in the Rust programming language. Here are the first steps to get started." />
  <meta name="twitter:title" content="CustomOS - Pt.7 - Interfacing with Rust - Dennis Salzner" />
  <meta name="twitter:image" content="" />

  <!-- syntax highlighting in code snippets -->
  <link rel="stylesheet" href="https://www.dennissalzner.de/css/main.css">
  <link rel="stylesheet" href="https://www.dennissalzner.de/css/style.css">
  
  <!-- jquery (for vimeo video embedding)-->
  <script src="https://www.dennissalzner.de/js/jquery.min.js"></script>
  
  <!-- photos -->
  <script src="https://www.dennissalzner.de/js/lightbox.js"></script>
  <link href="https://www.dennissalzner.de/css/lightbox.css" rel="stylesheet">
  
  <!-- diagramms -->
  <script src="https://www.dennissalzner.de/js/mermaid.min.js"></script>


<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P2BRPNLLXQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-P2BRPNLLXQ');
</script>


</head>

  <body>
    <div style="margin: 32px;">
    

<h1>Dennis Salzner - CustomOS - Pt.7 - Interfacing with Rust</h1>
<p align="right" style="font-size:80%"><a href="https://www.dennissalzner.de/"><< Back Home</a></p>

<div class="page-title">CustomOS - Pt.7 - Interfacing with Rust</div>
<div class="page-subtitle">Writing a Custom Operating System (CustomOS)</div>
<div class="page-seperator"></div>

<div class="post-content" itemprop="articleBody">
    <p><a href="https://github.com/dsalzner/customos/">
    <img style="position: absolute; top: 0; right: 0; border: 0; height: 100px" src="../../../../images/github-fork-ribbon.png" alt="Fork me on GitHub" />
</a></p>

<p style="font-size: 60%;" align="right">What</p>

<p>To further enhance the CustomOS we need a shell. A shell is literally the “shell” around the kernel that a user can interact with.</p>

<p>Since 2010 there is a new programming language called “Rust” that was developed by Mozilla Research. I’ll try to write the Shell for my CustomOS in Rust and share my experiences.</p>

<p>So far it’s been an hour on and off playing with Rust for a couple of days. Rust is new to me, but I’ve been devloping C/C++ applications for a long time. Let’s try to fill that graphics buffer from last time with code written in Rust.</p>

<p><img src="../../../../images/2024-01-28-So-CustomOsPt7-Shell-Rust/rust-colours.png" width="30%" /><img src="../../../../images/2024-01-28-So-CustomOsPt7-Shell-Rust/customos-colours.png" width="20%" /></p>

<h2 id="contents">Contents</h2>

<nav>
  <h4>Table of Contents</h4>
<ul id="markdown-toc">
  <li><a href="#contents" id="markdown-toc-contents">Contents</a></li>
  <li><a href="#shell" id="markdown-toc-shell">Shell</a>    <ul>
      <li><a href="#implementing-shells" id="markdown-toc-implementing-shells">Implementing Shells</a></li>
    </ul>
  </li>
  <li><a href="#rust" id="markdown-toc-rust">Rust</a>    <ul>
      <li><a href="#red-herrings" id="markdown-toc-red-herrings">Red Herrings</a></li>
      <li><a href="#first-impressions" id="markdown-toc-first-impressions">First Impressions</a></li>
      <li><a href="#why-try" id="markdown-toc-why-try">Why try</a></li>
    </ul>
  </li>
  <li><a href="#approach" id="markdown-toc-approach">Approach</a></li>
  <li><a href="#displaying-an-image-buffer-with-rust" id="markdown-toc-displaying-an-image-buffer-with-rust">Displaying an Image Buffer with Rust</a>    <ul>
      <li><a href="#a-first-hello-world" id="markdown-toc-a-first-hello-world">a first Hello World</a></li>
      <li><a href="#step-1-rough-start" id="markdown-toc-step-1-rough-start">Step 1, Rough start</a>        <ul>
          <li><a href="#installing-libraries" id="markdown-toc-installing-libraries">Installing Libraries</a></li>
          <li><a href="#compiler-compatibility" id="markdown-toc-compiler-compatibility">Compiler Compatibility</a></li>
          <li><a href="#non-standard-installation" id="markdown-toc-non-standard-installation">Non-Standard Installation</a></li>
          <li><a href="#workspace-folder-structure-auto-moving" id="markdown-toc-workspace-folder-structure-auto-moving">Workspace Folder structure auto-moving</a></li>
          <li><a href="#dependency-hell" id="markdown-toc-dependency-hell">Dependency Hell</a></li>
          <li><a href="#and-still-fails" id="markdown-toc-and-still-fails">and still fails</a></li>
          <li><a href="#example-codes-with-wried-include_bytes-macro" id="markdown-toc-example-codes-with-wried-include_bytes-macro">example codes with wried include_bytes macro</a></li>
          <li><a href="#with-evern-more-missing-dependencies" id="markdown-toc-with-evern-more-missing-dependencies">with evern more missing dependencies</a></li>
          <li><a href="#more-bloat" id="markdown-toc-more-bloat">more bloat</a></li>
          <li><a href="#and-broken-libs" id="markdown-toc-and-broken-libs">and broken libs</a></li>
          <li><a href="#first-step-conclusion" id="markdown-toc-first-step-conclusion">First Step Conclusion</a></li>
        </ul>
      </li>
      <li><a href="#step-2-promising-results" id="markdown-toc-step-2-promising-results">Step 2, Promising Results</a>        <ul>
          <li><a href="#different-libraries" id="markdown-toc-different-libraries">Different Libraries</a></li>
          <li><a href="#install-libraries" id="markdown-toc-install-libraries">Install libraries</a></li>
          <li><a href="#adapt-the-code" id="markdown-toc-adapt-the-code">Adapt the code</a></li>
          <li><a href="#pixel-buffer-shown-on-pc" id="markdown-toc-pixel-buffer-shown-on-pc">Pixel buffer shown on PC</a></li>
          <li><a href="#learnings" id="markdown-toc-learnings">Learnings</a></li>
          <li><a href="#wrapping-c-libraries" id="markdown-toc-wrapping-c-libraries">Wrapping C Libraries</a></li>
        </ul>
      </li>
      <li><a href="#step-3-filling-the-graphics-buffer-of-our-customos-from-rust" id="markdown-toc-step-3-filling-the-graphics-buffer-of-our-customos-from-rust">Step 3, Filling the graphics buffer of our CustomOS from Rust</a>        <ul>
          <li><a href="#first-try" id="markdown-toc-first-try">First Try</a></li>
          <li><a href="#smaller-issues" id="markdown-toc-smaller-issues">Smaller issues</a></li>
          <li><a href="#c-array-needs-conversion" id="markdown-toc-c-array-needs-conversion">C-Array needs conversion</a></li>
          <li><a href="#how-to-cast" id="markdown-toc-how-to-cast">How to cast</a></li>
          <li><a href="#unused-variables-need-prefix" id="markdown-toc-unused-variables-need-prefix">Unused variables need prefix</a></li>
          <li><a href="#no-resulting-library" id="markdown-toc-no-resulting-library">No resulting library</a></li>
          <li><a href="#check-resulting-library" id="markdown-toc-check-resulting-library">Check resulting library</a></li>
          <li><a href="#extend-the-makefile" id="markdown-toc-extend-the-makefile">Extend the Makefile</a></li>
          <li><a href="#incompatible-library" id="markdown-toc-incompatible-library">Incompatible Library</a></li>
          <li><a href="#target-spec" id="markdown-toc-target-spec">Target Spec</a>            <ul>
              <li><a href="#custom-target-spec-required" id="markdown-toc-custom-target-spec-required">Custom Target Spec Required</a></li>
              <li><a href="#check-spec" id="markdown-toc-check-spec">Check Spec</a></li>
              <li><a href="#custom-target-spec" id="markdown-toc-custom-target-spec">Custom Target Spec</a></li>
            </ul>
          </li>
          <li><a href="#need-to-rebuild-standard-libraries" id="markdown-toc-need-to-rebuild-standard-libraries">Need to rebuild standard libraries</a></li>
          <li><a href="#restricted_std" id="markdown-toc-restricted_std">restricted_std</a></li>
          <li><a href="#bloated-libs" id="markdown-toc-bloated-libs">Bloated libs</a></li>
          <li><a href="#manipulating-raw-c-array-in-rust-directly" id="markdown-toc-manipulating-raw-c-array-in-rust-directly">Manipulating raw C-Array in Rust directly</a></li>
          <li><a href="#issues-on-resource-constrainted-embedded-devices" id="markdown-toc-issues-on-resource-constrainted-embedded-devices">Issues on resource-constrainted embedded devices</a></li>
          <li><a href="#first-working-write-to-custom-os-graphics-buffer-from-rust" id="markdown-toc-first-working-write-to-custom-os-graphics-buffer-from-rust">First working write to Custom OS graphics buffer from Rust</a></li>
          <li><a href="#enhancing-the-code" id="markdown-toc-enhancing-the-code">Enhancing the code</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ul>

</nav>

<h2 id="shell">Shell</h2>

<p>In literature a shell is conceptionally often shown as:</p>

<p><img src="../../../../images/2024-01-28-So-CustomOsPt7-Shell-Rust/kernel-shell.png" width="10%" /></p>

<p>In simple terms: the <strong><em>kernel</em></strong> speaks to the hardware, the <strong><em>shell</em></strong> speaks to the <strong><em>kernel</em></strong>. On Unix-based Systems users can interact with the <strong><em>shell</em></strong> on command-line terminals or run utilities, the software, to do so.</p>

<p>#ä# Tasks of a Shell</p>

<p>In order to do this a typical shell</p>

<ul>
  <li>receives text-based input from the user</li>
  <li>responds with text</li>
</ul>

<p>and the text, or commands can be something along the lines of</p>

<ul>
  <li>cd - <strong>c</strong>hange to another <strong>d</strong>irectory</li>
  <li>ls - <strong>l</strong>ist/show the contents of the <strong>d</strong>irectory</li>
  <li>cat - con<strong>cat</strong>inate/show the contents of a file</li>
  <li>exec - run/<strong>exec</strong>ute a file</li>
</ul>

<p>and so on</p>

<h3 id="implementing-shells">Implementing Shells</h3>

<p>Implementation-wise this means writing a lot of string-parsing code. Along the lines of</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s">"cat "</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">showDirectoryContents</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Not particularly difficult, but tedious and error-prone due to many for loops and printf-family functions on ‘\0’ terminated char arrays.</p>

<p>It’s not that we’re building something safety critical, but format string bugs, buffer overflows and double free bugs are among the most common security flaws among C/C++ code to date.</p>

<h2 id="rust">Rust</h2>

<p>Rust compiles using the same LLVM used underneath the Clang C/C++ compiler. It could be a good match to experiment with for writing the Shell for the Custom OS.</p>

<p>I’ve found developing complex code and going head first into the rabbit hole is the best way to learn a new language. That approach has a much steeper learning curve than following the safe path of online tutorials with cherry-picked examples where the langauge excels.</p>

<h3 id="red-herrings">Red Herrings</h3>

<p>I remember all to well the single-line Quicksort implementation in Haskell that was mentioned all over text books. Yes, it is Quicksort in one line. But in practice it’s highly inefficient compared to any .sort(..) function in any common language and completely unusable apart from marvelling at in academia.</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">qsort</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">concat</span> <span class="p">[</span><span class="n">qsort</span> <span class="p">[</span><span class="n">y</span> <span class="o">|</span> <span class="n">y</span> <span class="o">&lt;-</span> <span class="n">tail</span> <span class="n">xs</span><span class="p">,</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">]</span> <span class="o">++</span> <span class="n">x</span> <span class="o">:</span> <span class="n">qsort</span> <span class="p">[</span><span class="n">y</span> <span class="o">|</span> <span class="n">y</span> <span class="o">&lt;-</span> <span class="n">tail</span> <span class="n">xs</span><span class="p">,</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="p">]</span> <span class="o">|</span> <span class="n">x</span> <span class="o">&lt;-</span> <span class="n">take</span> <span class="mi">1</span> <span class="n">xs</span><span class="p">]</span>
</code></pre></div></div>

<p>Hence I’ve found it’s much better to just try a langauge for something, see where it leads and ignore all cherry-picked examples of where a language may excel.</p>

<h3 id="first-impressions">First Impressions</h3>

<p>My first impression of Rust is that it’s</p>

<ul>
  <li>earily close to C/C++ as is to be expected given it compiles using LLVM that was developed for the clang C/C++ compiler as an alternative to Msvc/Gcc and so on.</li>
  <li>given all the built-in safe-guards and protection it’s probably on a higher level of abstraction than C and probably a lower level of abstraction than modern C++-11.</li>
  <li>in contrast to C/C++ where you can drop down to lower levels - all the way from templates and shared_ptrs to assembly - it likely locks you into that level of abstraction with lots of automatic optimization that, in practice, will be hard to control.</li>
  <li>it likely won’t be more capable than C/C++ as it’s built with the same LLVM underneath</li>
  <li>nobody in industry will rewrite all of their existing code just because there is a new kid on the block that has yet to prove itself and may dissappear at any time. It will be very important to be able to easily be able to mix Rust with C/C++ which is what made Python so popular as it does this really well.</li>
  <li>but the cargo package manager and the community mindset is so highly useful that it may have the potential to become a major player</li>
</ul>

<h3 id="why-try">Why try</h3>

<p>There’s a couple of reasons why Rust could be interesting for this task.</p>

<ul>
  <li>it’s a massive hype and I haven’t had the chance to try it yet.</li>
  <li>I need to get acquanted with it for work. I’d like to be able to make informed decisions.</li>
  <li>Rust is apparently a good fit for embedded systems. These are closely related to Custom OSes.</li>
  <li>the borrowing, mutable, safe/unsafe seems to be a good fit to avoid the above mentioned common string-parsing bugs in C/C++ code</li>
  <li>since there’s LLVM underneath I don’t see many potential issues apart from boiler-plate and uncontrollable dependencies being pulled in.</li>
</ul>

<h2 id="approach">Approach</h2>

<p>So how to approach this?</p>

<p>So far we have</p>

<ul>
  <li>a <code class="language-plaintext highlighter-rouge">char * screenBuffer</code> representing the pixels on the screen we need to fill</li>
  <li>and an interrupt-driven <code class="language-plaintext highlighter-rouge">_keyboardInterrupt</code> that passes a keyboard scancode and converted char of the keyboard input</li>
</ul>

<p>To connect this to Rust we need to</p>

<ul>
  <li>write Rust code, that</li>
  <li>produces a binary comparible object, that</li>
  <li>can be linked with the rest of the CustomOS kernel</li>
  <li>such that we can call the Rust-functions from C</li>
</ul>

<p>And in order to approach this a little more softly, we can first</p>

<ul>
  <li>write a standard desktop application, that</li>
  <li>displays a buffer representing pixels</li>
  <li>and learn to manipulate it in Rust with that</li>
</ul>

<h2 id="displaying-an-image-buffer-with-rust">Displaying an Image Buffer with Rust</h2>

<h3 id="a-first-hello-world">a first Hello World</h3>

<p>We can install the Rust compiler with</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>Rustc
</code></pre></div></div>

<p>and compile a hello world</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Hello World!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="step-1-rough-start">Step 1, Rough start</h3>

<p>To display an image buffer I came across the crate “eFrame” and tried to use it.</p>

<h4 id="installing-libraries">Installing Libraries</h4>

<p>Looks like we need the cargo package manager</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>cargo
</code></pre></div></div>

<p>To install a crate it seems we need to have initialised the current working directory and it’s not “install”, but “cargo add”, so</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cargo init
cargo add egui
</code></pre></div></div>

<h4 id="compiler-compatibility">Compiler Compatibility</h4>

<p>Turns out “epaint v0.25.0” requires requires Rustc 1.72 and we have 1.70.</p>

<p>Looks like the Rust compiler breaks compatibility so quickly that Debian package maintainers can’t keep up.</p>

<p>And so we do have to install Rust the recommended way.</p>

<h4 id="non-standard-installation">Non-Standard Installation</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt remove Rustc
curl <span class="nt">--proto</span> <span class="s1">'=https'</span> <span class="nt">--tlsv1</span>.2 https://sh.Rustup.rs <span class="nt">-sSf</span> | sh
</code></pre></div></div>

<p>Really unnerving to install software like that.</p>

<p>It installs to <code class="language-plaintext highlighter-rouge">$HOME/.cargo/bin</code> and adds aliases to <code class="language-plaintext highlighter-rouge">.profile</code> and <code class="language-plaintext highlighter-rouge">.bash.rc</code> as if <code class="language-plaintext highlighter-rouge">/usr/bin</code> didn’t exist.</p>

<h4 id="workspace-folder-structure-auto-moving">Workspace Folder structure auto-moving</h4>

<p>I had my code in the root directory. the <code class="language-plaintext highlighter-rouge">cargo init</code> seemed to have moved it in a wierd place.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./example-02/src/main.rs
./example-02/ui.rs
</code></pre></div></div>

<p>It copied <code class="language-plaintext highlighter-rouge">ui.rs</code> to <code class="language-plaintext highlighter-rouge">main.rs</code> and moved it to <code class="language-plaintext highlighter-rouge">src/</code> automatically, but okay.</p>

<h4 id="dependency-hell">Dependency Hell</h4>

<p>Try to add that crate now</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cargo add eframe
</code></pre></div></div>

<p>It install 185 crates (!). x11rb, wayland, xkeysm, cpu features, miniz_oxide (a compression library), …</p>

<h4 id="and-still-fails">and still fails</h4>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">egui</span><span class="p">::</span><span class="n">CtxRef</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nn">epi</span><span class="p">::</span><span class="n">Frame</span><span class="o">&lt;</span><span class="nv">'_</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
   <span class="p">|</span>                                      <span class="o">^^^^^^</span> <span class="n">not</span> <span class="n">found</span> <span class="k">in</span> <span class="err">`</span><span class="n">egui</span>
</code></pre></div></div>

<h4 id="example-codes-with-wried-include_bytes-macro">example codes with wried include_bytes macro</h4>

<p>In many examples online there is the <code class="language-plaintext highlighter-rouge">include_bytes</code> function.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">image_data</span> <span class="o">=</span> <span class="nd">include_bytes!</span><span class="p">(</span><span class="s">"rust-logo-256x256.png"</span><span class="p">);</span>
</code></pre></div></div>

<p>From my understanding it is a macro. So does that mean the image gets compiled into the executable uncompressed?</p>

<h4 id="with-evern-more-missing-dependencies">with evern more missing dependencies</h4>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">image</span><span class="p">::</span><span class="n">GenericImageView</span><span class="p">;</span>
   <span class="p">|</span>                 <span class="o">^^^^^</span> <span class="k">use</span> <span class="n">of</span> <span class="n">undeclared</span> <span class="k">crate</span> <span class="n">or</span> <span class="n">module</span> <span class="err">`</span><span class="n">image</span><span class="err">`</span>
</code></pre></div></div>

<h4 id="more-bloat">more bloat</h4>

<p>So we need the image library</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cargo add image
</code></pre></div></div>

<p>That installes 294 fruther crates: jpeg-decoder, tiff, event-listener, zune-inflatem ….</p>

<p>I just want to display an image here!</p>

<h4 id="and-broken-libs">and broken libs</h4>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">13</span> <span class="p">|</span>     <span class="k">fn</span> <span class="nf">update</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="o">&amp;</span><span class="nn">egui</span><span class="p">::</span><span class="n">CtxRef</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nn">epi</span><span class="p">::</span><span class="n">Frame</span><span class="o">&lt;</span><span class="nv">'_</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
   <span class="p">|</span>                                      <span class="o">^^^^^^</span> <span class="n">not</span> <span class="n">found</span> <span class="k">in</span> <span class="err">`</span><span class="n">egui</span><span class="err">`</span>
</code></pre></div></div>

<h4 id="first-step-conclusion">First Step Conclusion</h4>

<ul>
  <li>Rust doesn’t solve unfriendly libraries with unclean/instable interfaces</li>
  <li>extremly fine-granular libraries that cause hundreds of crates to be installed</li>
  <li>we need to maneuver around broken libraries</li>
</ul>

<h3 id="step-2-promising-results">Step 2, Promising Results</h3>

<p>In the meantime I had researched some less bloated approaches</p>

<h4 id="different-libraries">Different Libraries</h4>

<p>Image and minifb seem to be far lighter and hence less error-prone.</p>

<p>MiniFB is actually a wrapper [1] around a C-Library minifb [2]. It is similar to the “rawdraw” library I have used.</p>

<p>It’s basically a plattform-abstraction to display an image buffer on various platforms (android, opengl, ios, macos, wayland, x11, windows, webassembly, …).</p>

<p>So let’s try that instead.</p>

<h4 id="install-libraries">Install libraries</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>image-viewer
<span class="nb">cd </span>image-viewer/
cargo init
cargo add image
cargo add minifb
</code></pre></div></div>

<p>Installs 99 dependencies, but oh well.</p>

<h4 id="adapt-the-code">Adapt the code</h4>

<p>Adapted from examples</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">minifb</span><span class="p">::{</span><span class="n">Key</span><span class="p">,</span> <span class="n">Window</span><span class="p">,</span> <span class="n">WindowOptions</span><span class="p">};</span>

<span class="k">const</span> <span class="n">WIDTH</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="mi">640</span><span class="p">;</span>
<span class="k">const</span> <span class="n">HEIGHT</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">buffer</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">u32</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span> <span class="n">WIDTH</span> <span class="o">*</span> <span class="n">HEIGHT</span><span class="p">];</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">window</span> <span class="o">=</span> <span class="nn">Window</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span>
        <span class="s">"Test - ESC to exit"</span><span class="p">,</span>
        <span class="n">WIDTH</span><span class="p">,</span>
        <span class="n">HEIGHT</span><span class="p">,</span>
        <span class="nn">WindowOptions</span><span class="p">::</span><span class="nf">default</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="nf">.unwrap_or_else</span><span class="p">(|</span><span class="n">e</span><span class="p">|</span> <span class="p">{</span>
        <span class="nd">panic!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="n">window</span><span class="nf">.limit_update_rate</span><span class="p">(</span><span class="nf">Some</span><span class="p">(</span><span class="nn">std</span><span class="p">::</span><span class="nn">time</span><span class="p">::</span><span class="nn">Duration</span><span class="p">::</span><span class="nf">from_micros</span><span class="p">(</span><span class="mi">16600</span><span class="p">)));</span>

    <span class="k">while</span> <span class="n">window</span><span class="nf">.is_open</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">window</span><span class="nf">.is_key_down</span><span class="p">(</span><span class="nn">Key</span><span class="p">::</span><span class="n">Escape</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">in</span> <span class="n">buffer</span><span class="nf">.iter_mut</span><span class="p">()</span><span class="nf">.enumerate</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">_y</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">/</span> <span class="n">WIDTH</span><span class="p">;</span>
            <span class="k">let</span> <span class="n">_x</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">%</span> <span class="n">WIDTH</span><span class="p">;</span>
        
            <span class="k">if</span> <span class="mi">240</span> <span class="o">&gt;</span> <span class="n">_y</span> <span class="o">&amp;&amp;</span> <span class="mi">320</span> <span class="o">&gt;</span> <span class="n">_x</span> <span class="p">{</span>
              <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0x00ffff</span><span class="p">;</span> <span class="c1">// top-left, aqua</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="mi">240</span> <span class="o">&gt;</span> <span class="n">_y</span> <span class="o">&amp;&amp;</span> <span class="mi">320</span> <span class="o">&lt;</span> <span class="n">_x</span> <span class="p">{</span>
              <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0xff0000</span><span class="p">;</span> <span class="c1">// top-right, red</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="mi">240</span> <span class="o">&lt;</span> <span class="n">_y</span> <span class="o">&amp;&amp;</span> <span class="mi">320</span> <span class="o">&gt;</span> <span class="n">_x</span> <span class="p">{</span>
              <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0x00ff00</span><span class="p">;</span> <span class="c1">// bottom-left, green</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="mi">240</span> <span class="o">&lt;</span> <span class="n">_y</span> <span class="o">&amp;&amp;</span> <span class="mi">320</span> <span class="o">&lt;</span> <span class="n">_x</span> <span class="p">{</span>
              <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0x0000ff</span><span class="p">;</span> <span class="c1">// bottom-right, blue</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">window</span>
            <span class="nf">.update_with_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">WIDTH</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">)</span>
            <span class="nf">.unwrap</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="pixel-buffer-shown-on-pc">Pixel buffer shown on PC</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cargo build
</code></pre></div></div>

<p><img src="../../../../images/2024-01-28-So-CustomOsPt7-Shell-Rust/rust-colours.png" width="20%" /></p>

<h4 id="learnings">Learnings</h4>

<p>In Rust, if you want to modify a buffer, you need to set it “mut” (“mutable”):</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">buffer</span><span class="nf">.iter_mut</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It’s possible to set hex values as in C/C++</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0xff0000</span><span class="p">;</span> <span class="c1">// red</span>
<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0x00ff00</span><span class="p">;</span> <span class="c1">// green</span>
<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0x00ff00</span><span class="p">;</span> <span class="c1">// blue</span>
</code></pre></div></div>

<p>There are C/C++ Idioms [3], Python Idioms [4]</p>

<p>Where in Python</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
</code></pre></div></div>

<p>you can do</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">in</span> <span class="n">arr</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.enumerate</span><span class="p">()</span> <span class="p">{</span>
</code></pre></div></div>

<p>In Rust, which is cool.</p>

<h4 id="wrapping-c-libraries">Wrapping C Libraries</h4>

<p>I very briefly tried to wrap the “stb_truetype.h” single header library for TrueType-Font Rendering in Rust.</p>

<p>There is a guide for interoperability [5], but it seems a bit tedious.</p>

<p>It boils down to tagging structures <code class="language-plaintext highlighter-rouge">#[repr(C)]</code> to be C-Style memory aligned and <code class="language-plaintext highlighter-rouge">extern "C"</code> marking to make C functions accessible.</p>

<p>You can add a <code class="language-plaintext highlighter-rouge">build.rs</code>with something like</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nn">cc</span><span class="p">::</span><span class="nn">Build</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
        <span class="nf">.file</span><span class="p">(</span><span class="s">"c_src/lib.c"</span><span class="p">)</span>
        <span class="nf">.include</span><span class="p">(</span><span class="s">"c_include/lib.h"</span><span class="p">)</span>
        <span class="nf">.compile</span><span class="p">(</span><span class="s">"library"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>and cargo will run it during <code class="language-plaintext highlighter-rouge">cargo build</code>.</p>

<p>There’s a library for that</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cargo add cc
</code></pre></div></div>

<p>Currently C++ can’t be wrapped effecively due to C++ name mangling.</p>

<h3 id="step-3-filling-the-graphics-buffer-of-our-customos-from-rust">Step 3, Filling the graphics buffer of our CustomOS from Rust</h3>

<p>So we can show a raw image buffer on Linux and manipulate it.</p>

<p>Let’s see if we can get Rust to compile in a compatible way so we can link it to our CustomOS and use the code there.</p>

<h4 id="first-try">First Try</h4>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">graphicsUpdate</span><span class="p">(</span>
        <span class="n">buffer</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nn">cty</span><span class="p">::</span><span class="nb">c_char</span><span class="p">,</span>
        <span class="k">const</span> <span class="nb">u16</span> <span class="n">width</span><span class="p">,</span>
        <span class="k">const</span> <span class="nb">u16</span> <span class="n">height</span>
    <span class="p">);</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">keyboardInterrupt</span><span class="p">(</span>
      <span class="k">const</span> <span class="nn">cty</span><span class="p">::</span><span class="nb">c_char</span> <span class="n">key</span><span class="p">,</span>
      <span class="k">const</span> <span class="nb">u8</span> <span class="n">scancode</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">keyboardInterrupt</span><span class="p">(</span><span class="k">const</span> <span class="nn">cty</span><span class="p">::</span><span class="nb">c_char</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="nb">u8</span> <span class="n">scancode</span><span class="p">)</span> <span class="p">{</span>
  
<span class="p">}</span>
    
<span class="k">fn</span> <span class="nf">graphicsUpdate</span><span class="p">(</span><span class="n">buffer</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nn">cty</span><span class="p">::</span><span class="nb">c_char</span><span class="p">,</span> <span class="nb">u16</span> <span class="n">width</span><span class="p">,</span> <span class="nb">u16</span> <span class="n">height</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">in</span> <span class="n">buffer</span><span class="nf">.iter_mut</span><span class="p">()</span><span class="nf">.enumerate</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">let</span> <span class="n">_y</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">/</span> <span class="n">width</span><span class="p">;</span>
</code></pre></div></div>

<p>Multiple things wrong with that</p>

<h4 id="smaller-issues">Smaller issues</h4>

<ul>
  <li><code class="language-plaintext highlighter-rouge">extern "C"</code> goes in the same line as the function</li>
  <li><code class="language-plaintext highlighter-rouge">cty::c_char</code> needs to be installed by crate</li>
  <li>we need to add <code class="language-plaintext highlighter-rouge">#[no_mangle]</code></li>
</ul>

<p>so we install an additional C compatibility library:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cargo add cty
</code></pre></div></div>

<p>and</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">extern</span> <span class="s">"C"</span> <span class="k">fn</span> <span class="o">&lt;</span><span class="n">funktionsName</span><span class="o">&gt;</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div>

<h4 id="c-array-needs-conversion">C-Array needs conversion</h4>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buffer</span><span class="nf">.iter_mut</span><span class="p">()</span><span class="nf">.enumerate</span><span class="p">()</span> <span class="p">{</span>
   <span class="p">|</span>                            <span class="o">^^^^^^^^</span> <span class="n">method</span> <span class="n">not</span> <span class="n">found</span> <span class="k">in</span> <span class="err">`</span><span class="o">*</span><span class="k">mut</span> <span class="nb">i8</span><span class="err">`</span>
</code></pre></div></div>

<p>Need to convert it. Found [6], so something like</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">v</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="nn">slice</span><span class="p">::</span><span class="nf">from_raw_parts</span><span class="p">(</span><span class="n">buffer</span> <span class="k">as</span> <span class="o">*</span><span class="nn">cty</span><span class="p">::</span><span class="nb">c_char</span><span class="p">,</span> <span class="n">data_len</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">)</span> <span class="p">};</span>
</code></pre></div></div>

<p>that requires an additional library</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">std</span><span class="p">::{</span><span class="n">ptr</span><span class="p">,</span> <span class="n">slice</span><span class="p">};</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cargo add slice
</code></pre></div></div>

<p>and won’t work in our case as seen later.</p>

<h4 id="how-to-cast">How to cast</h4>

<p>Rust warns about incompatible types, neat.</p>

<p>Convert from u16 to usize by</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">usize</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div></div>

<p>Later found it’s easier to use “as” to cast:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">value</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="unused-variables-need-prefix">Unused variables need prefix</h4>

<p>We are forced to add “_” to unused variables to avoid warnings.</p>

<h4 id="no-resulting-library">No resulting library</h4>

<p>To get an actual object-file we need to</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cargo Rustc <span class="nt">--</span> <span class="nt">--emit</span><span class="o">=</span>obj
</code></pre></div></div>

<h4 id="check-resulting-library">Check resulting library</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nm <span class="nt">-D</span> shell-4c2220a1b1ab0f5d.o 
</code></pre></div></div>

<p>doesn’t work, but</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>readelf <span class="nt">-Ws</span> <span class="nt">--dyn-syms</span> shell-4c2220a1b1ab0f5d.o
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	89: 0000000000000000    15 FUNC    GLOBAL DEFAULT   40 keyboardInterrupt
	90: 0000000000000000   971 FUNC    GLOBAL DEFAULT   41 graphicsUpdate
</code></pre></div></div>

<p>Does, so our function did get exported to the library and is in global namespace.</p>

<h4 id="extend-the-makefile">Extend the Makefile</h4>

<p>Cargo writes in a strange directory with a hash.</p>

<p>Quick hack in the makefile</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>shell/shell.o: shell/shell.rs
	<span class="nb">cd </span>shell/ <span class="o">&amp;&amp;</span> cargo Rustc <span class="nt">--</span> <span class="nt">--emit</span><span class="o">=</span>obj <span class="o">&amp;&amp;</span> <span class="nb">cp </span>target/debug/deps/shell-<span class="k">*</span>.o shell.o
</code></pre></div></div>

<h4 id="incompatible-library">Incompatible Library</h4>

<p>The resulting library was built for the default target which doesn’t match our CustomOS</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>file shell/shell.o 
shell/shell.o: ELF 64-bit LSB relocatable, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, with debug_info, not stripped
</code></pre></div></div>

<p>We need 32-bit and release, like the object file from the graphics.c C-code.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>file graphics/graphics.o 
graphics/graphics.o: ELF 32-bit LSB relocatable, Intel 80386, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, not stripped
</code></pre></div></div>

<h4 id="target-spec">Target Spec</h4>

<h5 id="custom-target-spec-required">Custom Target Spec Required</h5>

<p>Tried the target</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--target</span> i686-unknown-linux-musl
</code></pre></div></div>

<p>But it expects a lot of missing symbols we haven’t/don’t want to implement in the CustomOS</p>

<ul>
  <li>enumerate.rs
    <ul>
      <li>core::panicking::panic</li>
    </ul>
  </li>
  <li>mod.rs
    <ul>
      <li>core::panicking::panic_in_cleanup</li>
      <li>__Rust_no_alloc_shim_is_unstable</li>
    </ul>
  </li>
  <li>intrinsics.rs
    <ul>
      <li>memcpy</li>
    </ul>
  </li>
  <li>alloc.rs
    <ul>
      <li>__Rust_alloc</li>
      <li>__Rust_alloc_zeroed</li>
      <li>__Rust_dealloc</li>
    </ul>
  </li>
  <li>shell.rs
    <ul>
      <li>Rust_eh_personality</li>
    </ul>
  </li>
  <li>unwind_pr.h
    <ul>
      <li>abort</li>
      <li>strlen</li>
      <li>malloc</li>
      <li>free</li>
    </ul>
  </li>
</ul>

<p>Turns out you can define a “panic-strategy” in a custom target spec.</p>

<h5 id="check-spec">Check Spec</h5>

<p>We can output the custom target spec like so</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Rustc <span class="nt">-Z</span> unstable-options <span class="nt">--target</span><span class="o">=</span>i686-unknown-linux-musl <span class="nt">--print</span> target-spec-json
</code></pre></div></div>

<h5 id="custom-target-spec">Custom Target Spec</h5>

<p>Found post about a similar issue on the osdev forums [7].</p>

<p>Mixed both specs together to get</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>i686-unknown-none-gnu.json
</code></pre></div></div>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"llvm-target"</span><span class="p">:</span><span class="w"> </span><span class="s2">"i686-unknown-none-gnu"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"data-layout"</span><span class="p">:</span><span class="w"> </span><span class="s2">"e-m:e-p:32:32-p270:32:32-p271:32:32-p272:64:64-i128:128-f64:32:64-f80:32-n8:16:32-S128"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"linker-flavor"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ld.lld"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"linker"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Rust-lld"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pre-link-args"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"ld.lld"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
       </span><span class="s2">"--script=linker.ld"</span><span class="w">
   </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"target-endian"</span><span class="p">:</span><span class="w"> </span><span class="s2">"little"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"target-pointer-width"</span><span class="p">:</span><span class="w"> </span><span class="s2">"32"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"target-c-int-width"</span><span class="p">:</span><span class="w"> </span><span class="s2">"32"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"arch"</span><span class="p">:</span><span class="w"> </span><span class="s2">"x86"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"os"</span><span class="p">:</span><span class="w"> </span><span class="s2">"none"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"features"</span><span class="p">:</span><span class="w"> </span><span class="s2">"-mmx,-sse,+soft-float"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"disable-redzone"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"panic-strategy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abort"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"executables"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>We can build against it by</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cargo Rustc <span class="nt">--target</span> i686-unknown-none-gnu.json <span class="nt">--release</span> <span class="nt">--</span> <span class="nt">--emit</span><span class="o">=</span>obj
</code></pre></div></div>

<h4 id="need-to-rebuild-standard-libraries">Need to rebuild standard libraries</h4>

<p>Now we’re missing some standard libraries as they haven’t been built against our custom target spec</p>

<ul>
  <li>core</li>
  <li>Result</li>
  <li>std</li>
  <li>Err</li>
</ul>

<p>For this we add</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-Z</span> build-std
</code></pre></div></div>

<p>to the Rustc/cargo command-line. It automatically rebuilds the standard libs with the custom target spec.</p>

<p>In order to use that “-Z” command-line flag we need to switch to the nightly version of the rust compiler <code class="language-plaintext highlighter-rouge">rustup default nightly</code>.</p>

<h4 id="restricted_std">restricted_std</h4>

<p>Turns out lib.rs in the library “slice” requires “restricted_std”</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>error[E0658]: use of unstable library feature <span class="s1">'restricted_std'</span>
</code></pre></div></div>

<p>The slice library depends on memset that we don’t have globally implemented in an accessable way for Rust.</p>

<p>Tried all sorts of things</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#![no_std]</span>
<span class="nd">#![no_main]</span>
<span class="nd">#![feature(alloc_error_handler)]</span>
<span class="nd">#![feature(restricted_std)]</span>
</code></pre></div></div>

<p>In the end I decided to just remove the library “slice” altogether.</p>

<h4 id="bloated-libs">Bloated libs</h4>

<p>Often the libs are bloated and rely on libc or libmusl functions such as “memset”, “memcpy”, … or implementations from an even higher level of abstraction that may not be available on an embedded device or a very limited CustomOS like ours.</p>

<p>The only option is to not use them.</p>

<p>Not sure, but it seems Rust tries to compile all code at least once regardless of whether it is being used or winds up in the resulting binary?</p>

<h4 id="manipulating-raw-c-array-in-rust-directly">Manipulating raw C-Array in Rust directly</h4>

<p>Yes you can, at the expense of not being able to use language features that benefit Rust, but as the only option to avoid dependency bloat.</p>

<p>So if we can’t use slice and can’t convert the C-Array to mutable <code class="language-plaintext highlighter-rouge">vec</code>, can we at least manipulate the memory directly in an <code class="language-plaintext highlighter-rouge">unsafe</code> way?</p>

<p>You can with many caveats.</p>

<ul>
  <li>you’ll skip all the protection that Rust has going for itself</li>
  <li>the pointer arithmetic in Rust is not that great</li>
  <li>tiny changes in the code trigger optimizations that uncontrollably drag in unwanted features</li>
</ul>

<h4 id="issues-on-resource-constrainted-embedded-devices">Issues on resource-constrainted embedded devices</h4>

<p>In general with Rust on embedded devices I see some issues:</p>

<ul>
  <li>these unwanted optimizations may rely on functions (in our case exception types for casting errors, memset, memcpy, …) that need to be implemented or “missing symbol” errors occur</li>
  <li>and they all cause the resulting binary to uncontrollably increase in size</li>
</ul>

<h4 id="first-working-write-to-custom-os-graphics-buffer-from-rust">First working write to Custom OS graphics buffer from Rust</h4>

<p>The following code</p>

<ul>
  <li>without the slice library and hence not converting the C-Array to a mutable <code class="language-plaintext highlighter-rouge">vec</code></li>
  <li>manipulating the C-Array directly in an unsafe block</li>
  <li>only setting every 2nd pixel to keep the Rust compiler from “optimizing” to the not implemented <code class="language-plaintext highlighter-rouge">memset</code></li>
  <li>a fixed for-loop range to avoid cast that would otherwise require exception code and related libraries</li>
</ul>

<p>does work:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">core</span><span class="p">::</span><span class="n">ptr</span><span class="p">;</span>

<span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">extern</span> <span class="s">"C"</span> <span class="k">fn</span> <span class="nf">keyboardInterrupt</span><span class="p">(</span><span class="n">_key</span><span class="p">:</span> <span class="nn">cty</span><span class="p">::</span><span class="nb">c_char</span><span class="p">,</span> <span class="n">_scancode</span><span class="p">:</span> <span class="nb">u8</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    
<span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">extern</span> <span class="s">"C"</span> <span class="k">fn</span> <span class="nf">graphicsUpdate</span><span class="p">(</span><span class="n">buffer</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nn">cty</span><span class="p">::</span><span class="nb">c_char</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">u16</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">u16</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">unsafe</span> <span class="p">{</span> 
      <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">..</span><span class="mi">2000</span> <span class="p">{</span>
        <span class="nn">ptr</span><span class="p">::</span><span class="nf">write</span><span class="p">(</span><span class="n">buffer</span><span class="nf">.wrapping_add</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="mi">6</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It’s build with the above mentioned target-spec</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>i686-unknown-none-gnu.json
</code></pre></div></div>

<p>and the following line in the makefile</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>shell/shell.o: shell/shell.rs
	<span class="nb">cd </span>shell/ <span class="o">&amp;&amp;</span> cargo Rustc <span class="nt">--target</span> i686-unknown-none-gnu.json <span class="nt">-Z</span> build-std <span class="nt">--release</span> <span class="nt">--</span> <span class="nt">--emit</span><span class="o">=</span>obj <span class="o">&amp;&amp;</span> <span class="nb">cp </span>target/i686-unknown-none-gnu/release/deps/shell-<span class="k">*</span>.o shell.o
</code></pre></div></div>

<p>The resulting <code class="language-plaintext highlighter-rouge">shell.o</code> object file can be directly linked to the excutable like a C-Library.</p>

<p>We can just call it from anywhere in C, since it’s in global namespace anyway</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">graphicsUpdate</span><span class="p">(</span><span class="n">VGA</span><span class="p">,</span> <span class="n">screenWidth</span><span class="p">,</span> <span class="n">screenHeight</span><span class="p">);</span>
</code></pre></div></div>

<p>The results looks like this</p>

<p><img src="../../../../images/2024-01-28-So-CustomOsPt7-Shell-Rust/customos-rust-shell.png" width="20%" /></p>

<h4 id="enhancing-the-code">Enhancing the code</h4>

<p>We can implement memset in rust</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">unsafe</span> <span class="k">extern</span> <span class="k">fn</span> <span class="nf">memset</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">i32</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">s</span><span class="nf">.offset</span><span class="p">(</span><span class="n">ii</span> <span class="k">as</span> <span class="nb">isize</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">;</span>
        <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">s</span>
<span class="p">}</span>
</code></pre></div></div>

<p>and then the following code works</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">extern</span> <span class="s">"C"</span> <span class="k">fn</span> <span class="nf">graphicsUpdate</span><span class="p">(</span><span class="n">buffer</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nn">cty</span><span class="p">::</span><span class="nb">c_char</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="nb">u16</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">u16</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">y</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">h</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">x</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">w</span> <span class="p">{</span>
      <span class="k">let</span> <span class="k">mut</span>  <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">y</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">x</span> <span class="p">{</span>
        <span class="n">v</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// top-left, cyan</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">y</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="o">/</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="p">{</span>
        <span class="n">v</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// top-right, red</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">x</span> <span class="p">{</span>
        <span class="n">v</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// bottom-left, green</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="o">/</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="p">{</span>
        <span class="n">v</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bottom-right, blue</span>
      <span class="p">}</span>

      <span class="k">unsafe</span> <span class="p">{</span> 
        <span class="nn">ptr</span><span class="p">::</span><span class="nf">write</span><span class="p">(</span><span class="n">buffer</span><span class="nf">.wrapping_add</span><span class="p">(</span><span class="nn">usize</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">w</span><span class="p">)),</span> <span class="n">v</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>With it the Custom OS shows</p>

<p><img src="../../../../images/2024-01-28-So-CustomOsPt7-Shell-Rust/customos-colours.png" width="20%" /></p>

<h2 id="conclusion">Conclusion</h2>

<p>So how do I feel about Rust…</p>

<ul>
  <li>Pointer arithmetic is not that great in Rust</li>
  <li>the language unintentionally drags in a log of bloat</li>
  <li>language, compiler and libs are very unstable so I expect to have to adapt code when I come back in the future</li>
</ul>

<p>But</p>

<ul>
  <li>I was able to compile code and link it to a C program for a very custom environment</li>
  <li>Rust does in parts have a very attractive syntax</li>
  <li>being able to use some of the Python idioms like “enumerate” is great</li>
  <li>it excels where C/C++ lacks: a package manager and a vibrant community outside of pure industry that share code</li>
</ul>

<p>It’s funny how the complaint of the bloat of cargo cult programming [8] is often heard especially among embedded developers and here we have a language with a package manager called “cargo” that brands itself as suitable for embedded devices.</p>

<p>To me it has a web-developer feel to it and that fits the picture as it’s written by the manufacturer of a very slow and inefficient web browser - that I do use daily though.</p>

<p>Ironically the package manager that is one of Rusts greatest advantages is also its greatest weakness: it’s easy to just drag in additional crates and that behaviour causes the bloat: interface instability and compatibility issues, executable size, long compile times, wasteful resource handling, and so on.</p>

<p>Regarding the CustomOS…</p>

<ul>
  <li>we can call a C function from Rust and fill that graphics buffer</li>
</ul>

<p>But we’ll need to implement some functions Rust libraries depend upon to be able to use the langauge properly</p>

<p>Otherwise every miniscule change of the code written in Rust will trigger missing symbols errors</p>

<hr />

<pre>
1] https://github.com/emoon/rust_minifb
2] https://github.com/emoon/minifb
3] https://maulingmonkey.com/guide/cpp-vs-rust/
4] https://benjamincongdon.me/blog/2018/03/23/Python-Idioms-in-rust/
5] https://docs.rust-embedded.org/book/interoperability/c-with-rust.html
6] https://stackoverflow.com/questions/50376516/creating-a-vec-in-rust-from-a-c-array-pointer-and-safely-freeing-it
7] https://forum.osdev.org/viewtopic.php?f=13&amp;t=41546
8] https://en.wikipedia.org/wiki/Cargo_cult_programming
</pre>


</div>

<script src="https://utteranc.es/client.js"
  repo="dsalzner/dsalzner.github.io"
	issue-term="CustomOS - Pt.7 - Interfacing with Rust"
	theme="boxy-light"
	crossorigin="anonymous"
	async>
</script>


</div>



    <div class="footer">
  D.Salzner : www.dennissalzner.de : 2024 <a href="/impr.html">imp</a><a href="/impr.html">ressum</a>
</div>

  </body>
</html>
