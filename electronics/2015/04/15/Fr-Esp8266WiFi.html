<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> - Dennis Salzner</title>

  <!-- search engine -->
  <meta name="description" content="Dennis Salzner"/>
  <link rel="canonical" href="/electronics/2015/04/15/Fr-Esp8266WiFi.html">
  <meta property="og:locale" content="en_EN" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content=" - Dennis Salzner" />
  <meta property="og:description" content="" />
  <meta property="og:url" content="/electronics/2015/04/15/Fr-Esp8266WiFi.html" />
  <meta property="og:site_name" content="Dennis Salzner" />
  <meta property="article:section" content="electronics" />
  <meta property="article:published_time" content="2015-04-15 00:00:00 +0200" />
  <meta property="article:modified_time" content="2015-04-15 00:00:00 +0200" />
  <meta property="og:updated_time" content="2015-04-15 00:00:00 +0200" />
  <meta property="og:image" content="" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:description" content="" />
  <meta name="twitter:title" content=" - Dennis Salzner" />
  <meta name="twitter:image" content="" />

  <!-- syntax highlighting in code snippets -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/style.css">
  
  <!-- jquery (for vimeo video embedding)-->
  <script src="/js/jquery.min.js"></script>
  
  <!-- photos -->
  <script src="/js/lightbox.js"></script>
  <link href="/css/lightbox.css" rel="stylesheet">
  
  <!-- diagramms -->
  <script src="/js/mermaid.min.js"></script>

</head>

  <body>
    <div style="margin: 32px;">
    
<h1>Dennis Salzner - 2015-04-15-Fr-Esp8266WiFi</h1>
<p align="right" style="font-size:80%"><a href="/"><< Back Home</a></p>
<div class="page-title"></div>
<div class="page-subtitle"></div>
<div class="page-seperator"></div>

<div class="post-content" itemprop="articleBody">
    <h2>ESP8266 WiFi</h2>
<h4>The ESP8266 Wifi Chip and an Arduino Nano used for posting data to a webserver</h4>

<hr />

<p style="font-size: 60%;" align="right">What?</p>

<p style="margin-bottom:16px;">
The ESP8266 is a Wifi-Module with integrated TCP/IP. It can be used to connect a microcontroller to a wireless access point in order to transmit data from the microcontroller to the internet. The device has a very low price.
</p>

<p style="font-size: 60%;" align="right">When?</p>

<p style="margin-bottom:16px;">
I received the first of my Wifi-Modules some time last year. My first use was a gas usage monitor (see <a href="http://www.dennissalzner.de/2014-11-07-Fr-GasMeterWifi.html">here</a>). It did work eventually, but the device kept on rebooting every once in a while. I couldn't get a stable connection, so I laid it to rest.
</p>

<p style="font-size: 60%;" align="right">Why?</p>

<p style="margin-bottom:16px;">
My goal is to use this to post data to a webserver. This is useful for project where I want to record data over time and analyse it later on. I want to use this for an internet-connected scale project and the gas usage monitor project.
</p>

<p style="font-size: 60%;" align="right">Background?</p>

<p style="margin-bottom:16px;">
The documentation on the internet has become a lot better. I have understood the device better and now have an easier setup using an Arduino Nano.
</p>

<p>GRAFIK: Aufbau Platine</p>

<p style="margin-bottom:16px;">
There are multiple points to be taken into concideration:
</p>

<ul>
  <li><b>UART</b> The ESP8266 uses a serial connection to talk to the microcontroller. If you need the serial connection for debugging, you will need to switch to a software simulation of an UART. This requires lower baud rates and a more powerful microcontroller with additional pins.
  </li>
  <li><b>Small Microcontrollers</b> Microcontrollers such as the Attiny85, which the DigiSpark uses, are too small. The software UART requires more flash program memory and pin connections, than the DigiSpark can offer. Software Serial seems to be very difficult with the DigiSpark, because it uses the same pins for the USB connection.
  </li>
  <li><b>Variants</b> The ESP8266 comes in multiple variants. Some of which are very difficult to solder. The ESP-03 for instance has a non-standard pin layout. The ESP-01 ist a lot easier to handle. Variant oftentimes have specifics such as special resistors or pins that have to be pulled to ground or left floating.
  </li>
  <li><b>Modes</b> The ESP8266 sports a very powerful processor. For many projects the ESP can be used without an additional microcontroller. The firmware on the ESP has to be replaced for this. The NodeMCU firmware for instance allows the ESP to be programmed in the LUA programming language. There is also an Arduino IDE add-on for programming the ESP directly from the Arduino IDE using the  "esptool", but this does not support standard arduino libraries and the ESP only has a small amount of pins for connecting other devices. Programming new firmwares requires pulling additional pins to ground.
  </li>
  <li><b>AT-Commands</b> The device is configured using AT-Commands. AT-Commands are best known for configuring modems oder mobil phones via serial connections. The AT command of the ESP allows scanning for WiFi Networks, connecting to WEP/WPA encrypted networks, read or set IP-Adresses, issuing HTTP requests to hosting a small webserver to name a few
  </li>
  <li><b>Features</b> The ESP is very versatile and can be used for many purposes from GET/POST requests to sending E-Mails via SMTP or spawning a telnet server.
  </li>
  <li><b>Voltage</b> The device need 3,3V and 5V will damage it. The inputs and outputs are not 5V tolerant, so voltage regulators and voltage dividers are necessary. It may be possible to steal 3,3V from the FTDI USB-RS232 converter on the bottom side of the Arduino Nano.
  </li>
  <li><b>Testing</b> The easiest way to test the ESP is to connect it using an FTDI-RS232 Interface. Then Software like "TeraTerm" (Windows) or "minicom" (Linux) can be used to issue AT commands and do prior testing.
  </li>
  <li><b>Embedding</b> The sequence of commands can then be programmed into a microcontroller, such as an Arduino Nano, to automatically transfer the  AT commands to the ESP via UART and achieve whatever it is supposed to achieve.
  </li>
  <li><b>Baud Rates</b> The UART baud rates also differ from variant to variant and sometimes even within the same variant. Common baud rates are 9600 and 115200. The easiest way to find out the baud rate is to try them. The ESP will only react to commands followed by NL (new line) and CR (carrage return). The baud rate can be reconfigured via AT commands and will remain on the newly configured baud rate.
  </li>
  <li><b>Arduino Libraries</b> There are Arduino libraries used to facilitate using the ESP8266 such as the "ESP8266WiFi.h" library.
  </li>
</ul>

<p style="font-size: 60%;" align="right">How?</p>

<p style="margin-bottom:16px;">
After my last attempts with an Attiny2313 and attempts with a DigiSpark, I settled for an Arduino Nano. The Arduino Nano is also a very small device, but has an ATmega168 which is sufficient for the purpose. 
</p>

<p style="font-size: 150%; margin-bottom:32px; margin-top:32px">
<b>1. Connecting the ESP to the Arduino Nano</b>
</p>

<p style="margin-bottom:16px;">
The easiest way to connect the ESP8266 (I am using the ESP-01) is to use an LM317 voltage regulator with a 470 and a 270 Ohm resistor in order to convert 5V to aproximatly 3,3V. The Arduino Nano has a pin with 3,3 V written on it, but I found it does not carry 3,3 V.
</p>

<p style="margin-bottom:16px;">
A voltage divider with a 1 kOhm and a 2 kOhm resistor (or two 1 kOhm resistors in series) is connected to the ESP8266 RX line. There are alternative with 1N4148 Diodes and obscure resistors, but I found the 1kOhm resistors to work just fine. TX can be connected directly.
</p>

<p style="margin-bottom:16px;">
The ESP-01 requires an additional 10k resistor going from CH_PD to Vcc. 
</p>

<p>GRAFIK: Schaltplan - mit einer verbindung</p>

<p style="font-size: 150%; margin-bottom:32px; margin-top:32px">
<b>2. Initial Configuration</b>
</p>

<p style="margin-bottom:16px;">
Now for the initial configuration and testing it is best to connect the ESP8266 directly to a USB to RS232 converter and use a terminal programm on the computer.
</p>

<p style="margin-bottom:16px;">
I have a trick to simlify this: The Arduino Nano has an FTDI USB to RS232 converter integrated on the under side. The TXD and RXD pins are easily accessible. They are the right next to the ISP programming connector. So a simple solution for the initial configuration of the ESP is to upload an empty sketch to the Arduino Nano, to make sure it does not send anything on the UART and then to connect the ESP to the RXD and TXD pins on the Arduino Nano. The Serial Monitor ("Tools" -&gt; "Serial Monitor") of the Arduino IDE can then be used to talk to the ESP. Remember to set the baud rate and enable NL (new line) and CR (carrage return).
</p>

<p style="margin-bottom:16px;">
Now we can send "AT" to the ESP and see if it responds with "OK". If it does not, then something has gone wrong. Perhaps the baud rate setting is wrong or the TX/RX connections need to be swapped
</p>

<p>GRAFIK: Serial Monitor AT und OK</p>

<p style="margin-bottom:16px;">
If that works, then you can send "AT+CIOBAUD=9600" to set the baud rate to 9600 baud. Make sure to set the Arduino Serial Moniator to 9600 baud from now on.
</p>

<p style="font-size: 150%; margin-bottom:32px; margin-top:32px">
<b>3. Communicate to the ESP through the Arduino Nano</b>
</p>

<p style="margin-bottom:16px;">
The next best move is to programm the Arduino Nano start a second UART in software and connect the ESP to this software UART. And also programm it to forward data coming from the real UART (connected to the computer) to the software UART (connected to the ESP8266) and back.
</p>

<p style="margin-bottom:16px;">
If this works and by issuing "AT" you get the "OK" response, then everything is connected and configured correctly.
</p>

<p style="margin-bottom:16px;">
To do this we need to reconnect the RX and TX of the ESP8266 to the pins used for software UART on the Arduino. Pins D8 and D9. 
</p>

<p>GRAFIK: Schaltplan - mit zweiter verbindung</p>

<p>The following Arduino sketch spawns the software UART and forwards all data coming from on UART to the other.</p>

<p><code>
#include &lt;SoftwareSerial.h&gt;<br />SoftwareSerial softSerial(8, 9); // RX, TX<br /><br />void setup() <br />{<br />  uint32_t baud = 9600;<br />  Serial.begin(baud);<br />  softSerial.begin(baud);<br />  Serial.print(&quot;SETUP!! @&quot;);<br />  Serial.println(baud);<br />}<br /><br />void loop() <br />{<br />    while(softSerial.available() &gt; 0) <br />    {<br />      char a = softSerial.read();<br />      if(a == '\0')<br />        continue;<br />      if(a != '\r' &amp;&amp; a != '\n' &amp;&amp; (a &lt; 32))<br />        continue;<br />      Serial.print(a);<br />    }<br />    <br />    while(Serial.available() &gt; 0)<br />    {<br />      char a = Serial.read();<br />      Serial.write(a);<br />      softSerial.write(a);<br />    }<br />}
</code></p>

<p style="font-size: 150%; margin-bottom:32px; margin-top:32px">
<b>4. Preparing Webserver</b>
</p>

<p style="margin-bottom:16px;">
The purpose of this setup is to be able to post data from the microcontroller to a webserver. In order to do this the web server must be able to receive data. For this I have PHP installed and I have added a simple PHP script.
</p>

<p style="margin-bottom:16px;">
The following PHP script dumps what it received in a GET-Request into a file called "esp.log" on the server. If the code is stored in log.php, then "http://[yourdomain/log.php?daten=test3" should make "test3" be written into "esp.log".
</p>

<p><code>
&lt;?php
$fp = fopen('esp.log', 'a');
fwrite($fp, $_GET['daten'] . "\r\n");
fclose($fp);
?&gt;
</code></p>

<p style="margin-bottom:16px;">
This can and should be tested in an internet browser on your computer, to make sure it works.
</p>

<p style="font-size: 150%; margin-bottom:32px; margin-top:32px">
<b>5. Manually connect and post the data</b>
</p>

<p style="margin-bottom:16px;">
At this stage we should be able to manually post data to the webserver through the Arduino which forwards commands to the ESP8266 by using the Arduino IDE serial monitor.
</p>

<p><code></code></p>

<p>AT             // should respond with “OK”</p>

<p>AT+CWMODE=3    // necessary?</p>

<p>AT+CWLAP       // List all Wireless LAN access points</p>

<p>AT+CWJAP=”NETWORK_NAME”,”PASSWORD” // Connect to a Wireless LAN access point using WEP or WPA</p>

<p>AT+CIPSTART=”TCP”,”YOUR_SERVER”,80 // Establish a TCP connection to your server. This can also be a domain name. The ESP will resolve the IP-Addresses.</p>

<p>AT+CIPSEND=32   // Send 32 chars of data</p>

<p>GET /esp/log.php?daten=ficka\r\n  // The 32 chars &lt;- hier muss HTTP/1.0 dahinter</p>

<p>&lt;/code&gt;</p>

<p>GRAFIK: Komplette kommunikation</p>

<p style="font-size: 150%; margin-bottom:32px; margin-top:32px">
<b>6. Additional Sources</b>
</p>

<ul>
  <li><a href="https://blogs.msdn.microsoft.com/abhinaba/2016/01/23/esp8266-wifi-with-arduino-uno-and-nano/">Microsoft Blog Post, 2kOhm voltage divider</a>
  </li>
  <li><a href="http://www.esp8266.com/viewtopic.php?f=8&amp;t=458">baud rates can vary</a></li>
  <li><a href="https://blog.silvertech.at/esp8266-onewire-daten-an-web-server-uebergeben-arduino/">1-Wire Temp-Sensors Post to Webserver</a></li>
  <li><a href="https://dzone.com/articles/tutorial-web-server-esp8266">Webserver on ESP, firmware modifications?</a></li>
  <li><a href="http://randomnerdtutorials.com/esp8266-web-server/">Webserver on ESP without Arduino using NodeMCU firmware</a></li>
  <li><a href="https://github.com/esp8266/Arduino/issues/851">GET and POST requests</a></li>
  <li><a href="http://www.esp8266.com/viewtopic.php?f=32&amp;t=4840">Post to Webserver</a></li>
  <li><a href="https://petestechprojects.wordpress.com/2014/11/30/simple-communication-through-esp8266-wifi-module/">AT commands for Wifi scanning</a></li>
  <li><a href="http://www.martyncurrey.com/arduino-esp8266-web-server/">Webserver using ESP and Arduino</a></li>
  <li><a href="http://www.whatimade.today/esp8266-easiest-way-to-program-so-far">Programming the ESP from the Arduino IDE without an Arduino using the "esptool"</a></li>
  <li><a href="http://www.allaboutcircuits.com/projects/how-to-make-an-interactive-tcp-server-nodemcu-on-the-esp8266">ESP NodeMCU Lua programming and LuaTool</a></li>
  <li><a href="http://www.rei-labs.net/esp8266-connecting-to-internet">Send Get Request</a></li>
  <li><a href="https://github.com/espressif/ESP8266_AT/wiki/CIPSEND">AT command reference</a></li>
  <li><a href="http://robinsonia.com/wp/?p=360">Socket timeouts, AT+CIPSTO=60</a></li>
  <li><a href="https://mcuoneclipse.com/2014/12/14/tutorial-iot-datalogger-with-esp8266-wifi-module-and-frdm-kl25z">Post to ThingSpeak IoT Cloud</a></li>
  <li><a href="http://stackoverflow.com/questions/3328189/php-dump-request-to-file">PHP code to write to a file</a></li>
  <li><a href="http://stackoverflow.com/questions/359047/php-detecting-request-type-get-post-put-or-delete">Detecting different request types in PHP</a></li>
</ul>

<p style="font-size: 60%;" align="right">Progress?</p>

<p style="margin-bottom:16px;">

</p>


</div>

<script src="https://utteranc.es/client.js"
  repo="dsalzner/dsalzner.github.io"
	issue-term=""
	theme="boxy-light"
	crossorigin="anonymous"
	async>
</script>

</div>



    <div class="footer">
  D.Salzner : www.dennissalzner.de : 2021
</div>

  </body>
</html>
