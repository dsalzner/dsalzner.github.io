<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>Atari ST Mega Keyboard and Mouse Adapter - Dennis Salzner</title>
  
  
  <!-- search engine -->
  <meta name="description" content="The keyboard and mouse of my 30 year old Mega ST seems to still function, but the keyboard has been dropped many times and it’s bound to break. I found a project [1] on the inte..."/>
  <link rel="canonical" href="https://www.dennissalzner.de/retrocomp/2023/06/13/Di-AtariStKeyboardMouse.html">
  <meta property="og:locale" content="en_EN" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Atari ST Mega Keyboard and Mouse Adapter - Dennis Salzner" />
  <meta property="og:description" content="The keyboard and mouse of my 30 year old Mega ST seems to still function, but the keyboard has been dropped many times and it’s bound to break. I found a pro..." />
  <meta property="og:url" content="https://www.dennissalzner.de/retrocomp/2023/06/13/Di-AtariStKeyboardMouse.html" />
  <meta property="og:site_name" content="Dennis Salzner" />
  <meta property="article:section" content="RetroComp" />
  <meta property="article:published_time" content="2023-06-13 00:00:00 +0200" />
  <meta property="article:modified_time" content="2023-06-13 00:00:00 +0200" />
  <meta property="og:updated_time" content="2023-06-13 00:00:00 +0200" />
  <meta property="og:image" content="" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:description" content="The keyboard and mouse of my 30 year old Mega ST seems to still function, but the keyboard has been dropped many times and it’s bound to break. I found a project [1] on the inte..." />
  <meta name="twitter:title" content="Atari ST Mega Keyboard and Mouse Adapter - Dennis Salzner" />
  <meta name="twitter:image" content="" />

  <!-- syntax highlighting in code snippets -->
  <link rel="stylesheet" href="https://www.dennissalzner.de/css/main.css">
  <link rel="stylesheet" href="https://www.dennissalzner.de/css/style.css">
  
  <!-- jquery (for vimeo video embedding)-->
  <script src="https://www.dennissalzner.de/js/jquery.min.js"></script>
  
  <!-- photos -->
  <script src="https://www.dennissalzner.de/js/lightbox.js"></script>
  <link href="https://www.dennissalzner.de/css/lightbox.css" rel="stylesheet">
  
  <!-- diagramms -->
  <script src="https://www.dennissalzner.de/js/mermaid.min.js"></script>


<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P2BRPNLLXQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-P2BRPNLLXQ');
</script>


</head>

  <body>
    <div style="margin: 32px;">
    

<h1>Dennis Salzner - Atari ST Mega Keyboard and Mouse Adapter</h1>
<p align="right" style="font-size:80%"><a href="https://www.dennissalzner.de/"><< Back Home</a></p>

<div class="page-title">Atari ST Mega Keyboard and Mouse Adapter</div>
<div class="page-subtitle">Connecting modern peripherals to the Atari ST</div>
<div class="page-seperator"></div>

<div class="post-content" itemprop="articleBody">
    <p style="font-size: 60%;" align="right">What</p>

<p>The keyboard and mouse of my 30 year old Mega ST seems to still function, but the keyboard has been dropped many times and it’s bound to break.
I found a project [1] on the internet to build an adapter in order to connect a modern mouse and keyboard to the Atari and I’m trying to recreate it.</p>

<p>The original author clearly states that the code is not complete and has significant bugs. That I can confirm, but it’s a very good starting point. I did get it to work to some extend. The software we can improve upon.</p>

<p>1] https://oldcomputer.info/hacks/mega_key/index.htm</p>

<p style="font-size: 60%;" align="right">When</p>

<p>Even though this project is as basic as it gets for a micro controllers electronics project it took a few attempts. The original project uses an Atmega328. Since this is the exact chip on the Arduino Nano I thought I’d throw one of them at it. Turns out the Arduino Nano I have is one of those cheap fakes with a CH340 instead of an FTDI and probably other issues.</p>

<p>So after the third or so attempt with the Nano I had three options: Give up, buy an expensive original Arduino Nano or build a custom circuit with one of my other Atmega328s in easier to solder DIP packaging I have.</p>

<p>The stripes on the stripe board I have trends to leak solder to neighbouring stripes and my soldering iron is starting to show symptoms of old age with a short circuit in the wiring. Also RJ12 connectors are extremely annoying to solder. All of that adds to the frustration when you’re working on such a seemingly simple project and you want it to simply work.
I had to try three different Atmega328 chips until one worked. Could be bad soldering, could be more fake chips from eBay. The third one works very reliably. I need to stop ordering micro controllers from eBay.</p>

<p>Either way I chose to go the long way and build a complete custom circuit and solder the Atmega328 to perfboard.</p>

<div class="row" style=" display: flex;">
  <div style="font-size: 8pt; padding: 15px">
  <a href="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/board.jpg" data-lightbox="image" data-title=""><img src="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/board.jpg" alt="" class="" style="height:192px;" /></a>
   <br />
    Electronics soldered to perfboard
  </div>
</div>

<p style="font-size: 60%;" align="right">Why</p>

<p style="font-size: 60%;" align="right">Background</p>

<p>In order to connect a modern Keyboard and Mouse I need an adapter that can translate from modern interfaces - either USB oder PS/2 - to the Atari protocol for keyboard and mice.</p>

<p>Many USB Keyboard and Mice came with passive PS/2 adapters that can drop the device from USB to PS/2. Now PS/2 is much easier to interface. Since I have a PS/2 compliant USB Mouse and a PS/2 Keyboard I’ll be going for that.</p>

<p>It seems my Microsoft “Basic Optical Mouse” doesn’t work with the adapter, although it does on the computer. The Logitech MX518 works fine. The “Microsoft Wired Keyboard 500”, which comes with a PS/2 plug also works.</p>

<p style="font-size: 60%;" align="right">How</p>

<p><b>Hardware</b></p>

<p>The circuit is relatively standard. We need to wire an ISP socket for programming, a socket for the FTDI serial connection, the PS/2 sockets and the RJ12 Atari Connector.</p>

<p>You could use an Arduino Nano, but original boards have long delivery times and I wouldn’t recommend the cheap knock-offs.
The only disadvantage is you’ll need an ISP programmier to program bare Atmega chips. The Arduino Nanos come with a custom boot loader that allows programming via the integrated usb port.</p>

<div class="row" style=" display: flex;">
  <div style="font-size: 8pt; padding: 15px">
  <a href="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/atmega328.png" data-lightbox="image" data-title=""><img src="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/atmega328.png" alt="" class="" style="height:192px;" /></a>
   <br />
    Atmega328 Pinout
  </div>
</div>

<p><b>Programmer</b></p>

<p>In order to program an Atmega328 you need an ISP connector.</p>

<div class="row" style=" display: flex;">
  <div style="font-size: 8pt; padding: 15px">
  <a href="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/isp.png" data-lightbox="image" data-title=""><img src="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/isp.png" alt="" class="" style="height:192px;" /></a>
   <br />
    ISP connector
  </div>
</div>

<p>There are 6 wires that need to be soldered: Miso (Master-In Slave-Out), Mosi (Master-Out, Slave-In), Sck (Clock) Reset, Vcc and GND.</p>

<div class="row" style=" display: flex;">
  <div style="font-size: 8pt; padding: 15px">
  <a href="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/isp-atmega328.png" data-lightbox="image" data-title=""><img src="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/isp-atmega328.png" alt="" class="" style="height:192px;" /></a>
   <br />
    Atmega328 ISP connector
  </div>
</div>

<p><b>Serial Communication</b></p>

<p>For serial communication I put a 6-pin socket on the board so I can quickly connect and disconnect an FT232RL Serial to USB-converter for debugging.</p>

<p>Note:</p>
<ul>
  <li>I’m not using a 10k Resistor from Vcc to Reset. I see that in many schematics and it’s probably recommended, but never made a difference for me.</li>
  <li>I’m also skipping an external Oscillator as we can use the internal Oscillator of the Atmega.</li>
</ul>

<div class="row" style=" display: flex;">
  <div style="font-size: 8pt; padding: 15px">
  <a href="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/ftdi-atmega.png" data-lightbox="image" data-title=""><img src="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/ftdi-atmega.png" alt="" class="" style="height:192px;" /></a>
   <br />
    FTDI Serial Converter to Atmega
  </div>
</div>

<p><b>PS/2 Connectors</b></p>

<p>For the PS/2 Connectors I started with Din5 sockets with adapters to PS/2 for lack of PS/2 sockets. It works the same. In the meantime I’ve ordered proper PS/2 sockets.</p>

<div class="row" style=" display: flex;">
  <div style="font-size: 8pt; padding: 15px">
  <a href="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/Ps2Din5.png" data-lightbox="image" data-title=""><img src="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/Ps2Din5.png" alt="" class="" style="height:192px;" /></a>
   <br />
    PS/2 and Din-5 connectors
  </div>
  
  <div style="font-size: 8pt; padding: 15px">
  <a href="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/ps2.png" data-lightbox="image" data-title=""><img src="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/ps2.png" alt="" class="" style="height:192px;" /></a>
   <br />
    PS/2 connector
  </div>
</div>

<p>The Vcc and Gnd lines are connected to the Atmegas, the Ataris 5V Vcc and Gnc, the FTDI and also the PS/2 sockets.
This is okay since we will be using either the FTDI during debugging or the Atari ST keyboard/mouse port.</p>

<ul>
  <li>Data and Clock for the keyboard go to PD2 and PD3 respectively, als seen in the code.</li>
  <li>Data and Clock for the mouse go to PD4 and PD4 respectively.</li>
</ul>

<p><b>Atari Connector</b></p>

<p>The Atari Keyboard/Mouse Connector is an RJ12 socket. The outer two pins on both sides are Vcc and Gnd. The two pins in the middle are TX and RX.</p>

<div class="row" style=" display: flex;">
  <div style="font-size: 8pt; padding: 15px">
  <a href="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/AtariConnector.png" data-lightbox="image" data-title=""><img src="../../../../images/2023-06-13-Di-AtariStKeyboardMouse/AtariConnector.png" alt="" class="" style="height:192px;" /></a>
   <br />
    Atari Keyboard/Mouse Connector (image from oldcomputer.info)
  </div>
</div>

<p>I use an RJ12 socket, because soldering directly to the fine RJ12 cables tends to break them very easily.</p>

<p><b>Joystick Connectors</b></p>

<p>The original schematic has connectors for two Joysticks. I don’t need the joysticks so I’m ignoring them.</p>

<p><b>Software</b></p>

<p>We need to hook up the programmer. I’m using AVR ISP MkII from Atmel. Also connect the FTDI to the PC. It not only enables serial communication, but also provides the Atmega328 with power during debugging.</p>

<p><b>First Test</b></p>

<p>As a first test to see if everything works we can send some text via the serial Port to the PC.</p>

<p>Because I like to keep things reproducible I wrote a self-contained script and because I’m on Linux I can.
The script grabs the Arduino command-line tool, “arduino-cli” and compiles and uploads a short example code that continuously sends “test” to the computer.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/arduino-cli"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"arduino-cli exists"</span>
<span class="k">else
  </span><span class="nb">cd</span> <span class="nv">$HOME</span>/
  wget https://downloads.arduino.cc/arduino-cli/arduino-cli_latest_Linux_64bit.tar.gz
  <span class="nb">tar</span> <span class="nt">-xvf</span> arduino-cli_latest_Linux_64bit.tar.gz
<span class="k">fi
</span><span class="nv">arduinocli</span><span class="o">=</span><span class="nv">$HOME</span>/arduino-cli</code></pre></figure>

<p>And our example code</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">mkdir</span> /tmp/01-serial/
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; /tmp/01-serial/01-serial.ino
void setup() {
  Serial.begin(9600);
  while (!Serial) { }
}
void loop() {
  delay(500);
  Serial.write("test");
}
EOT</span></code></pre></figure>

<p>Now as I’m not using an Arduino Nano and I want to be able to set the clock manually the “MiniCore” Arduino board manager is a good option.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">${</span><span class="nv">arduinocli</span><span class="k">}</span> config add board_manager.additional_urls https://mcudude.github.io/MiniCore/package_MCUdude_MiniCore_index.json
<span class="k">${</span><span class="nv">arduinocli</span><span class="k">}</span> core update-index
<span class="k">${</span><span class="nv">arduinocli</span><span class="k">}</span> core <span class="nb">install </span>MiniCore:avr
<span class="k">${</span><span class="nv">arduinocli</span><span class="k">}</span> board details <span class="nt">--fqbn</span> MiniCore:avr:328</code></pre></figure>

<p>We need to set the fuses of the chip so that we get an 8 MHz clock without clock division by 8.
There are online fuse calculators that yield “0xE2” when you set the appropriate checkboxes.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">avrdude</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/bin/avrdude"</span>
<span class="k">${</span><span class="nv">avrdude</span><span class="k">}</span> <span class="nt">-C</span> <span class="nv">$HOME</span>/.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/etc/avrdude.conf <span class="nt">-v</span> <span class="nt">-V</span> <span class="nt">-patmega328p</span> <span class="nt">-cavrispmkII</span> <span class="nt">-Pusb</span> <span class="nt">-U</span> lfuse:w:0xE2:m </code></pre></figure>

<p>With that we can compile the code</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">${</span><span class="nv">arduinocli</span><span class="k">}</span> compile <span class="nt">--fqbn</span> MiniCore:avr:328 <span class="nt">--board-options</span> <span class="s2">"clock=8MHz_internal"</span> /tmp/01-serial/01-serial.ino</code></pre></figure>

<p>and upload it</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">${</span><span class="nv">arduinocli</span><span class="k">}</span> upload <span class="nt">-P</span> avrispmkii <span class="nt">--verbose</span> /tmp/01-serial/01-serial.ino <span class="nt">--fqbn</span> MiniCore:avr:328</code></pre></figure>

<p>To test if the hardware is working we can keep the FTDI connected and open a serial monitor</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">picocom /dev/ttyUSB0 <span class="nt">-b</span> 9600</code></pre></figure>

<p>We should see it printing “test” on the screen continuously.</p>

<p><b>Actual Code</b></p>

<p>With the above working we can move to the actual code.</p>

<p>So grab MegaPS2_20180427.7z from the web page [1]</p>

<p>1] https://oldcomputer.info/hacks/mega_key/index.htm</p>

<p>With the above set up and tested we can simply compile and upload.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> <span class="nv">$HOME</span>/
wget https://oldcomputer.info/hacks/mega_key/MegaPS2_20180427.7z
7za x MegaPS2_20180427.7z <span class="nt">-o</span>/tmp/

<span class="k">${</span><span class="nv">arduinocli</span><span class="k">}</span> compile <span class="nt">--fqbn</span> MiniCore:avr:328 <span class="nt">--board-options</span> <span class="s2">"clock=8MHz_internal"</span> /tmp/PS2_Test/PS2_Test.ino
<span class="k">${</span><span class="nv">arduinocli</span><span class="k">}</span> upload <span class="nt">-P</span> avrispmkii <span class="nt">--verbose</span> /tmp/PS2_Test/PS2_Test.ino <span class="nt">--fqbn</span> MiniCore:avr:328</code></pre></figure>

<p>The code is configured to use a 7812 baud-rate which is due to the Atari ST requirements on its keyboard/mouse port.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">picocom /dev/ttyUSB0 <span class="nt">-b</span> 7812</code></pre></figure>

<p><b>Connect to the Atari</b></p>

<p>As the AtariST is to be connected to the same TX/RX lines that we are using for the FTDI we need to remove the FTDI and power the atmega328 directly from the 5V line of the Atari’s Keyboard and Mouse Port.</p>

<p>If the mouse moves, but quickly jumps to the far right side of the screen that can be due to the baud-rate being configured to 9600 - used for debugging - instead of the 7812.</p>

<p style="font-size: 60%;" align="right">Progress</p>

<p>The whole contraption works to some extent.</p>

<ul>
  <li>when conncected to the computer via FTDI I can see the lights flashing when keys are pressed and I can receive the Atari commands in the serial monitor.</li>
  <li>because the PS/2 code goes through an initialisation I found you may need to disconnect and reconnect the peripherals for them to be registered.</li>
  <li>the mouse moves perfectly well, but double clicking doesn’t seem to work for me</li>
  <li>on the keyboard some keys don’t work and on my first try the ‘k’ key got stuck and wouldn’t release</li>
</ul>

<p>It seems most issues are purely software related and I’ll probably do some fixes at some point.</p>

<p><b>Edit 2023-07-24:</b> I’ve since rewritten most of the software. It’s more stable now, but unfortunately now only either the keyboard or the mouse works, but not both combined. With both combined the mouse stops functioning on the first key press on the keyboard. It doesn’t seem to be an interrupt/serial communication issue, but possibly due to my incomplete Atari serial protocol implementation.</p>

</div>

<script src="https://utteranc.es/client.js"
  repo="dsalzner/dsalzner.github.io"
	issue-term="Atari ST Mega Keyboard and Mouse Adapter"
	theme="boxy-light"
	crossorigin="anonymous"
	async>
</script>


</div>



    <div class="footer">
  D.Salzner : www.dennissalzner.de : 2024 <a href="/impr.html">imp</a><a href="/impr.html">ressum</a>
</div>

  </body>
</html>
